<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Controle de Retirada de Cestas - WSNET</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        // Configuração Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc,
            getDocs,
            query,
            where,
            updateDoc,
            deleteDoc,
            doc,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCeuevUqlHbvwYKlwv8MOD6yxAycfSNmwk",
            authDomain: "controle-cestas-b332b.firebaseapp.com",
            projectId: "controle-cestas-b332b",
            storageBucket: "controle-cestas-b332b.firebasestorage.app",
            messagingSenderId: "917123925292",
            appId: "1:917123925292:web:fb727ea217745c00a91889"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Exportar funções Firebase para uso global
        window.firebaseDb = db;
        window.firebaseCollections = { collection, addDoc, getDocs, query, where, updateDoc, deleteDoc, doc, onSnapshot };
        window.firebaseInitialized = true;
    </script>
    <style>
        /* ====== VARIÁVEIS DA PALETA WSNET ====== */
        :root {
            --wsnet-primary: #0066CC;
            --wsnet-primary-dark: #004C99;
            --wsnet-primary-light: #3399FF;
            --wsnet-secondary: #0099FF;
            --wsnet-accent: #66CCFF;
            --wsnet-success: #00CC66;
            --wsnet-warning: #FF9900;
            --wsnet-danger: #FF3333;
            --wsnet-info: #0099CC;
            --wsnet-bg-light: #F0F8FF;
            --wsnet-bg-card: #FFFFFF;
            --wsnet-border: #E0F0FF;
            --wsnet-text-dark: #003366;
            --wsnet-text-medium: #666666;
            --wsnet-text-light: #999999;
            --shadow-sm: 0 2px 8px rgba(0, 102, 204, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 102, 204, 0.12);
            --shadow-lg: 0 8px 24px rgba(0, 102, 204, 0.16);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--wsnet-bg-light);
            color: var(--wsnet-text-dark);
            line-height: 1.6;
        }

        /* ====== LAYOUT RESPONSIVO ====== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, var(--wsnet-primary-dark) 0%, var(--wsnet-primary) 100%);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .logo-icon {
            font-size: 28px;
            background: rgba(255, 255, 255, 0.2);
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-text h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .logo-text span {
            font-size: 12px;
            opacity: 0.8;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--wsnet-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Menu */
        .menu {
            padding: 0 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            margin: 4px 0;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .menu-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-weight: 500;
        }

        .menu-item .material-icons {
            font-size: 20px;
        }

        .menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 16px 20px;
        }

        /* User Info */
        .user-info {
            padding: 20px;
            margin-top: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-details h4 {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .user-role {
            font-size: 12px;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }

        .logout-btn {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 16px 24px;
            background: var(--wsnet-bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .page-title h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--wsnet-primary-dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-actions {
            display: flex;
            gap: 12px;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--wsnet-primary-dark);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin-right: 12px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }

        /* Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--wsnet-bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--wsnet-border);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--wsnet-primary-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Stats Cards */
        .stat-card {
            text-align: center;
            padding: 30px 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 24px;
        }

        .stat-icon.total { background: rgba(0, 102, 204, 0.1); color: var(--wsnet-primary); }
        .stat-icon.pending { background: rgba(255, 153, 0, 0.1); color: var(--wsnet-warning); }
        .stat-icon.percentage { background: rgba(0, 204, 102, 0.1); color: var(--wsnet-success); }
        .stat-icon.company { background: rgba(102, 204, 255, 0.1); color: var(--wsnet-accent); }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--wsnet-primary-dark);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--wsnet-text-medium);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--wsnet-border);
            background: var(--wsnet-bg-card);
            -webkit-overflow-scrolling: touch;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-primary {
            background: var(--wsnet-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--wsnet-primary-dark);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--wsnet-primary);
            color: var(--wsnet-primary);
        }

        .btn-outline:hover {
            background: var(--wsnet-primary);
            color: white;
        }

        .btn-success {
            background: var(--wsnet-success);
            color: white;
        }

        .btn-warning {
            background: var(--wsnet-warning);
            color: white;
        }

        .btn-danger {
            background: var(--wsnet-danger);
            color: white;
        }

        .btn-info {
            background: var(--wsnet-info);
            color: white;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--wsnet-text-dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--wsnet-border);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: all 0.3s;
            background: var(--wsnet-bg-card);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--wsnet-primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        /* Search */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box .material-icons {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--wsnet-text-light);
        }

        .search-box input {
            padding-left: 48px;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(0, 204, 102, 0.1);
            color: var(--wsnet-success);
        }

        .badge-warning {
            background: rgba(255, 153, 0, 0.1);
            color: var(--wsnet-warning);
        }

        .badge-danger {
            background: rgba(255, 51, 51, 0.1);
            color: var(--wsnet-danger);
        }

        .badge-info {
            background: rgba(102, 204, 255, 0.1);
            color: var(--wsnet-accent);
        }

        /* Charts */
        .chart-container {
            background: var(--wsnet-bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Filters */
        .filters-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--wsnet-bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            animation: fadeIn 0.3s;
            padding: 10px;
        }

        .modal-content {
            background: var(--wsnet-bg-card);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            margin: 20px auto;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
            position: relative;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--wsnet-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--wsnet-bg-card);
            z-index: 1;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--wsnet-border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            position: sticky;
            bottom: 0;
            background: var(--wsnet-bg-card);
            z-index: 1;
        }

        /* Alerts */
        .alert {
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s;
        }

        .alert-success {
            background: rgba(0, 204, 102, 0.1);
            border-left: 4px solid var(--wsnet-success);
            color: var(--wsnet-success);
        }

        .alert-error {
            background: rgba(255, 51, 51, 0.1);
            border-left: 4px solid var(--wsnet-danger);
            color: var(--wsnet-danger);
        }

        .alert-warning {
            background: rgba(255, 153, 0, 0.1);
            border-left: 4px solid var(--wsnet-warning);
            color: var(--wsnet-warning);
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--wsnet-primary) 0%, var(--wsnet-primary-dark) 100%);
        }

        .login-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: var(--wsnet-bg-card);
            border-radius: var(--radius-lg);
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo .material-icons {
            font-size: 48px;
            color: var(--wsnet-primary);
            margin-bottom: 16px;
        }

        .login-logo h1 {
            color: var(--wsnet-primary-dark);
            margin-bottom: 8px;
            font-size: 24px;
        }

        .login-logo p {
            color: var(--wsnet-text-medium);
            font-size: 14px;
        }

        /* Tabs System */
        .tab-content {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tab-content.active {
            display: block;
            opacity: 1;
        }

        /* Mobile Actions */
        .mobile-actions {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .mobile-action-btn {
            flex: 1;
            min-width: 120px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Responsive Design */
        /* Tablet */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filters-bar {
                flex-wrap: wrap;
            }
            
            .filter-group {
                min-width: calc(50% - 8px);
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .admin-actions {
                width: 100%;
                overflow-x: auto;
                padding-bottom: 8px;
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 15px;
            }
            
            .page-title h1 {
                font-size: 20px;
            }
            
            .admin-actions {
                display: none;
            }
            
            .mobile-actions {
                display: flex;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .filters-bar {
                flex-direction: column;
                padding: 15px;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .stat-value {
                font-size: 28px;
            }
            
            .stat-card {
                padding: 20px 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px auto;
                max-height: 90vh;
            }
            
            .modal-header h3 {
                font-size: 18px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .chart-container {
                padding: 15px;
            }
            
            .chart-container canvas {
                max-height: 250px;
            }
        }

        /* Small Mobile */
        @media (max-width: 480px) {
            .main-content {
                padding: 10px;
            }
            
            .top-bar {
                padding: 12px;
                border-radius: var(--radius-md);
            }
            
            .card {
                padding: 15px;
                border-radius: var(--radius-md);
            }
            
            .filters-bar {
                padding: 12px;
                border-radius: var(--radius-md);
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .modal-footer {
                padding: 15px;
                flex-direction: column;
            }
            
            .modal-footer .btn {
                width: 100%;
            }
            
            .stat-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .login-card {
                padding: 20px;
            }
            
            .login-logo h1 {
                font-size: 20px;
            }
        }

        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn, .menu-item, .logout-btn {
                min-height: 44px;
            }
            
            .form-control, select, input {
                font-size: 16px;
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-screen" style="display: none;">
        <div class="login-container">
            <div class="login-card">
                <div class="login-logo">
                    <span class="material-icons">shopping_basket</span>
                    <h1>Controle de Cestas</h1>
                    <p>Sistema de Gestão - WSNET TELECOM</p>
                </div>

                <div id="loginAlert" class="alert" style="display: none;"></div>

                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="loginEmail" placeholder="seu@email.com" required value="gente.gestao@email.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Senha</label>
                        <input type="password" class="form-control" id="loginPassword" placeholder="Sua senha" required value="wsnet1205*">
                    </div>

                    <button type="submit" class="btn btn-primary btn-block" id="btnLogin">
                        <span class="material-icons">login</span>
                        Entrar
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Aplicação Principal -->
    <div id="mainApp" style="display: none;">
        <!-- Overlay para fechar menu mobile -->
        <div class="overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <div class="app-container">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="logo">
                        <div class="logo-icon">
                            <span class="material-icons">shopping_basket</span>
                        </div>
                        <div class="logo-text">
                            <h2>WSNET Cestas</h2>
                            <span>Sistema de Controle</span>
                        </div>
                    </div>
                    
                    <div class="sync-status">
                        <div class="status-dot"></div>
                        <span>Sincronizado</span>
                    </div>
                </div>

                <div class="menu">
                    <a href="javascript:void(0)" class="menu-item active" onclick="showTab('dashboard')">
                        <span class="material-icons">dashboard</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="javascript:void(0)" class="menu-item" onclick="showTab('retirada')">
                        <span class="material-icons">shopping_cart</span>
                        <span>Retiradas</span>
                    </a>
                    <a href="javascript:void(0)" class="menu-item" onclick="showTab('colaboradores')">
                        <span class="material-icons">group</span>
                        <span>Colaboradores</span>
                    </a>
                    <a href="javascript:void(0)" class="menu-item" onclick="showTab('relatorios')">
                        <span class="material-icons">assessment</span>
                        <span>Relatórios</span>
                    </a>
                    
                    <div class="menu-divider"></div>
                    
                    <a href="javascript:void(0)" class="menu-item" onclick="openGerenciarDepartamentos()">
                        <span class="material-icons">business</span>
                        <span>Departamentos</span>
                    </a>
                    <a href="javascript:void(0)" class="menu-item" onclick="openGerenciarEmpresas()">
                        <span class="material-icons">apartment</span>
                        <span>Empresas</span>
                    </a>
                </div>

                <div class="user-info">
                    <div class="user-profile">
                        <div class="user-avatar">
                            <span class="material-icons">person</span>
                        </div>
                        <div class="user-details">
                            <h4 id="userName"></h4>
                            <span class="user-role" id="userRole">Admin</span>
                        </div>
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        <span class="material-icons">logout</span>
                        <span>Sair</span>
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Top Bar -->
                <div class="top-bar">
                    <div style="display: flex; align-items: center; width: 100%;">
                        <button class="mobile-menu-toggle" onclick="toggleSidebar()">
                            <span class="material-icons">menu</span>
                        </button>
                        <div class="page-title">
                            <h1>
                                <span class="material-icons" id="pageIcon">dashboard</span>
                                <span id="pageTitle">Dashboard</span>
                            </h1>
                        </div>
                    </div>
                    
                    <div class="admin-actions" id="adminButtons">
                        <button type="button" class="btn btn-warning btn-sm" onclick="abrirModalNovoMes()">
                            <span class="material-icons">event_note</span>
                            Novo Mês
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="abrirModalLimparRetiradas()">
                            <span class="material-icons">delete_sweep</span>
                            Limpar Retiradas
                        </button>
                    </div>
                    
                    <!-- Mobile Actions -->
                    <div class="mobile-actions">
                        <button type="button" class="btn btn-warning btn-sm mobile-action-btn" onclick="abrirModalNovoMes()">
                            <span class="material-icons">event_note</span>
                            Novo Mês
                        </button>
                        <button type="button" class="btn btn-danger btn-sm mobile-action-btn" onclick="abrirModalLimparRetiradas()">
                            <span class="material-icons">delete_sweep</span>
                            Limpar
                        </button>
                    </div>
                </div>

                <!-- Alert Message -->
                <div id="alert" class="alert"></div>

                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <div class="filters-bar">
                        <div class="filter-group">
                            <label class="form-label">Filtrar por Empresa:</label>
                            <select class="form-control" id="filtroEmpresaDashboard" onchange="carregarDashboard()">
                                <option value="todas">Todas as Empresas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="form-label">Filtrar por Cidade:</label>
                            <select class="form-control" id="filtroCidadeDashboard" onchange="carregarDashboard()">
                                <option value="todas">Todas as Cidades</option>
                                <option value="Itanhaém">Itanhaém</option>
                                <option value="Mongaguá">Mongaguá</option>
                                <option value="Peruíbe">Peruíbe</option>
                            </select>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="card stat-card">
                            <div class="stat-icon total">
                                <span class="material-icons">group</span>
                            </div>
                            <div class="stat-value" id="totalColaboradores">0</div>
                            <div class="stat-label">Total de Colaboradores</div>
                        </div>
                        
                        <div class="card stat-card">
                            <div class="stat-icon pending">
                                <span class="material-icons">pending_actions</span>
                            </div>
                            <div class="stat-value" id="pendentes">0</div>
                            <div class="stat-label">Pendentes</div>
                        </div>
                        
                        <div class="card stat-card">
                            <div class="stat-icon percentage">
                                <span class="material-icons">percent</span>
                            </div>
                            <div class="stat-value" id="percentualRetirado">0%</div>
                            <div class="stat-label">Percentual Retirado</div>
                        </div>
                        
                        <div class="card stat-card">
                            <div class="stat-icon company">
                                <span class="material-icons">location_city</span>
                            </div>
                            <div class="stat-value" id="cidadeAtual">Todas</div>
                            <div class="stat-label">Cidade Selecionada</div>
                        </div>
                    </div>

                    <!-- Gráfico -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="card-title">
                                <span class="material-icons">pie_chart</span>
                                Status das Retiradas
                            </h3>
                        </div>
                        <div style="height: 300px;">
                            <canvas id="chartStatus"></canvas>
                        </div>
                    </div>

                    <!-- Distribuição por Cidade -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="material-icons">location_on</span>
                                Distribuição por Cidade
                            </h3>
                        </div>
                        <div id="distribuicaoCidade">
                            <div style="text-align: center; padding: 40px;">
                                <span class="material-icons" style="font-size: 48px; color: var(--wsnet-border); opacity: 0.5;">location_on</span>
                                <p style="color: var(--wsnet-text-light); margin-top: 16px;">
                                    Carregando distribuição por cidade...
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Últimas Retiradas -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="material-icons">history</span>
                                Últimas Retiradas
                            </h3>
                        </div>
                        <div id="ultimasRetiradas">
                            <div style="text-align: center; padding: 40px;">
                                <span class="material-icons" style="font-size: 48px; color: var(--wsnet-border); opacity: 0.5;">shopping_basket</span>
                                <p style="color: var(--wsnet-text-light); margin-top: 16px;">
                                    Nenhuma retirada registrada ainda.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Retirada Tab -->
                <div id="retirada" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="material-icons">shopping_cart</span>
                                Retiradas Pendentes
                            </h3>
                        </div>
                        
                        <div class="filters-bar">
                            <div class="filter-group">
                                <label class="form-label">Filtrar por Empresa:</label>
                                <select class="form-control" id="filtroEmpresaRetirada" onchange="carregarRetirada()">
                                    <option value="todas">Todas as Empresas</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Filtrar por Cidade:</label>
                                <select class="form-control" id="filtroCidadeRetirada" onchange="carregarRetirada()">
                                    <option value="todas">Todas as Cidades</option>
                                    <option value="Itanhaém">Itanhaém</option>
                                    <option value="Mongaguá">Mongaguá</option>
                                    <option value="Peruíbe">Peruíbe</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Buscar Colaborador:</label>
                                <div class="search-box">
                                    <span class="material-icons">search</span>
                                    <input type="text" class="form-control" id="searchRetirada" placeholder="Buscar colaborador..." onkeyup="filtrarColaboradoresRetirada()">
                                </div>
                            </div>
                        </div>

                        <div id="listaRetirada">
                            <div style="text-align: center; padding: 40px;">
                                <span class="material-icons" style="font-size: 48px; color: var(--wsnet-border); opacity: 0.5;">group</span>
                                <p style="color: var(--wsnet-text-light); margin-top: 16px;">
                                    Carregando colaboradores...
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Colaboradores Tab -->
                <div id="colaboradores" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="material-icons">group</span>
                                Colaboradores
                                <span id="contadorColaboradoresFiltrados" style="font-size: 14px; color: var(--wsnet-text-medium); margin-left: 12px;"></span>
                            </h3>
                            <div style="display: flex; gap: 12px;">
                                <button type="button" class="btn btn-primary" onclick="openCadastroColaborador()">
                                    <span class="material-icons">add</span>
                                    Novo Colaborador
                                </button>
                            </div>
                        </div>

                        <div class="filters-bar">
                            <div class="filter-group">
                                <label class="form-label">Filtrar por Empresa:</label>
                                <select class="form-control" id="filtroEmpresaColaboradores" onchange="filtrarColaboradores()">
                                    <option value="todas">Todas as Empresas</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Filtrar por Cidade:</label>
                                <select class="form-control" id="filtroCidadeColaboradores" onchange="filtrarColaboradores()">
                                    <option value="todas">Todas as Cidades</option>
                                    <option value="Itanhaém">Itanhaém</option>
                                    <option value="Mongaguá">Mongaguá</option>
                                    <option value="Peruíbe">Peruíbe</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Filtrar por Status:</label>
                                <select class="form-control" id="filtroStatusColaboradores" onchange="filtrarColaboradores()">
                                    <option value="ativo">Ativos</option>
                                    <option value="inativo">Inativos</option>
                                    <option value="todos">Todos</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Buscar:</label>
                                <div class="search-box">
                                    <span class="material-icons">search</span>
                                    <input type="text" class="form-control" id="searchColaborador" placeholder="Buscar colaborador..." onkeyup="filtrarColaboradores()">
                                </div>
                            </div>
                        </div>

                        <!-- Export Buttons -->
                        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-outline btn-sm" onclick="exportarColaboradoresPDF()">
                                <span class="material-icons">picture_as_pdf</span>
                                Exportar PDF
                            </button>
                            <button type="button" class="btn btn-outline btn-sm" onclick="exportarColaboradoresExcel()">
                                <span class="material-icons">grid_on</span>
                                Exportar Excel
                            </button>
                        </div>

                        <div class="table-container">
                            <div style="display: flex; padding: 16px; background: var(--wsnet-bg-light); border-bottom: 1px solid var(--wsnet-border); font-weight: 600; color: var(--wsnet-primary-dark);">
                                <div style="flex: 2;">Nome</div>
                                <div style="flex: 1;">Empresa</div>
                                <div style="flex: 1;">Cidade</div>
                                <div style="flex: 1;">Departamento</div>
                                <div style="flex: 1; text-align: center;">Dependentes</div>
                                <div style="flex: 1; text-align: center;">Status</div>
                                <div style="flex: 1; text-align: center;">Ações</div>
                            </div>
                            <div id="listaColaboradores">
                                <div style="text-align: center; padding: 40px;">
                                    <span class="material-icons" style="font-size: 48px; color: var(--wsnet-border); opacity: 0.5;">group</span>
                                    <p style="color: var(--wsnet-text-light); margin-top: 16px;">
                                        Nenhum colaborador cadastrado.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Relatórios Tab -->
                <div id="relatorios" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="material-icons">assessment</span>
                                Relatórios
                            </h3>
                        </div>

                        <div class="filters-bar">
                            <div class="filter-group">
                                <label class="form-label">Mês (MM):</label>
                                <select class="form-control" id="mesRelatorio">
                                    <option value="01">Janeiro</option>
                                    <option value="02">Fevereiro</option>
                                    <option value="03">Março</option>
                                    <option value="04">Abril</option>
                                    <option value="05">Maio</option>
                                    <option value="06">Junho</option>
                                    <option value="07">Julho</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Ano (AAAA):</label>
                                <input type="number" class="form-control" id="anoRelatorio" placeholder="2025" min="2020" max="2100">
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Empresa:</label>
                                <select class="form-control" id="empresaRelatorio">
                                    <option value="todas">Todas as Empresas</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Cidade:</label>
                                <select class="form-control" id="cidadeRelatorio">
                                    <option value="todas">Todas as Cidades</option>
                                    <option value="Itanhaém">Itanhaém</option>
                                    <option value="Mongaguá">Mongaguá</option>
                                    <option value="Peruíbe">Peruíbe</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Tipo de Lista:</label>
                                <select class="form-control" id="tipoListaRelatorio" onchange="carregarRelatorioManual()">
                                    <option value="ambas">Ambas as Listas</option>
                                    <option value="retirados">Apenas Retirados</option>
                                    <option value="nao_retirados">Apenas Não Retirados</option>
                                </select>
                            </div>
                            <div class="filter-group" style="align-self: flex-end;">
                                <button type="button" class="btn btn-primary" onclick="carregarRelatorioManual()" id="btnGerarRelatorio">
                                    <span class="material-icons">search</span>
                                    Gerar Relatório
                                </button>
                            </div>
                        </div>

                        <div class="dashboard-grid" style="margin-bottom: 30px;">
                            <div class="card stat-card">
                                <div class="stat-icon total">
                                    <span class="material-icons">group</span>
                                </div>
                                <div class="stat-value" id="relatorioTotalColaboradores">0</div>
                                <div class="stat-label">Total Colaboradores</div>
                            </div>
                            
                            <div class="card stat-card">
                                <div class="stat-icon total">
                                    <span class="material-icons">shopping_cart_checkout</span>
                                </div>
                                <div class="stat-value" id="relatorioTotalRetiradas">0</div>
                                <div class="stat-label">Retiradas Realizadas</div>
                            </div>
                            
                            <div class="card stat-card">
                                <div class="stat-icon percentage">
                                    <span class="material-icons">percent</span>
                                </div>
                                <div class="stat-value" id="relatorioPercentual">0%</div>
                                <div class="stat-label">Percentual Retirado</div>
                            </div>
                            
                            <div class="card stat-card">
                                <div class="stat-icon company">
                                    <span class="material-icons">location_city</span>
                                </div>
                                <div class="stat-value" id="relatorioCidade">Todas</div>
                                <div class="stat-label">Cidade Selecionada</div>
                            </div>
                        </div>

                        <!-- Export Buttons -->
                        <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-outline" onclick="exportarRelatorioPDF()">
                                <span class="material-icons">picture_as_pdf</span>
                                Exportar PDF
                            </button>
                            <button type="button" class="btn btn-outline" onclick="exportarRelatorioExcel()">
                                <span class="material-icons">grid_on</span>
                                Exportar Excel
                            </button>
                        </div>

                        <!-- Seções de Relatório -->
                        <div style="display: grid; gap: 24px;">
                            <div class="card" id="cardRetirados" style="display: none;">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <span class="material-icons">check_circle</span>
                                        Colaboradores que Já Retiraram
                                    </h3>
                                </div>
                                <div id="listaRetirados" style="padding: 16px;">
                                    <div style="text-align: center; padding: 20px;">
                                        <span class="material-icons" style="font-size: 36px; color: var(--wsnet-border); opacity: 0.5;">info</span>
                                        <p style="color: var(--wsnet-text-light); margin-top: 12px;">
                                            Selecione os filtros e clique em "Gerar Relatório"
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="card" id="cardNaoRetiraram" style="display: none;">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <span class="material-icons">pending_actions</span>
                                        Colaboradores que Não Retiraram
                                    </h3>
                                </div>
                                <div id="listaNaoRetiraram" style="padding: 16px;">
                                    <div style="text-align: center; padding: 20px;">
                                        <span class="material-icons" style="font-size: 36px; color: var(--wsnet-border); opacity: 0.5;">info</span>
                                        <p style="color: var(--wsnet-text-light); margin-top: 12px;">
                                            Selecione os filtros e clique em "Gerar Relatório"
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <!-- Modal Cadastro/Edição Colaborador -->
    <div id="modalColaborador" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalColaboradorTitulo">Cadastrar Colaborador</h3>
                <span class="material-icons" style="cursor: pointer;" onclick="closeModal('modalColaborador')">close</span>
            </div>
            <div class="modal-body">
                <form id="formColaborador">
                    <input type="hidden" id="colaboradorId">
                    
                    <div class="form-group">
                        <label class="form-label">Nome Completo *</label>
                        <input type="text" class="form-control" id="nomeColaborador" required placeholder="Nome e sobrenome">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Empresa *</label>
                        <select class="form-control" id="empresaColaborador" required>
                            <option value="">Selecione a empresa...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Retirada em (Cidade) *</label>
                        <select class="form-control" id="cidadeColaborador" required>
                            <option value="">Selecione a cidade...</option>
                            <option value="Itanhaém">Itanhaém</option>
                            <option value="Mongaguá">Mongaguá</option>
                            <option value="Peruíbe">Peruíbe</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Departamento *</label>
                        <select class="form-control" id="departamentoColaborador" required>
                            <option value="">Selecione o departamento...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select class="form-control" id="statusColaborador" required>
                            <option value="ativo" selected>Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                </form>

                <!-- Botões para Dependentes -->
                <div style="display: flex; gap: 8px; margin: 20px 0;">
                    <button type="button" class="btn btn-outline active" onclick="mostrarAbaDependentes('lista')" style="flex: 1;">
                        <span class="material-icons">list</span> Dependentes
                    </button>
                    <button type="button" class="btn btn-outline" onclick="mostrarAbaDependentes('adicionar')" style="flex: 1;">
                        <span class="material-icons">person_add</span> Adicionar
                    </button>
                </div>

                <!-- Aba de Lista de Dependentes -->
                <div id="abaListaDependentes" style="margin-top: 20px;">
                    <h4 style="margin: 0 0 16px 0; color: var(--wsnet-primary-dark); font-size: 14px;">Dependentes Cadastrados</h4>
                    <div id="listaDependentesCadastrados" style="background: var(--wsnet-bg-light); padding: 16px; border-radius: var(--radius-md);">
                        <p style="color: var(--wsnet-text-light); text-align: center; padding: 10px;">
                            Nenhum dependente cadastrado.
                        </p>
                    </div>
                </div>

                <!-- Aba de Adicionar Dependente -->
                <div id="abaAdicionarDependente" style="margin-top: 20px; display: none;">
                    <h4 style="margin: 0 0 16px 0; color: var(--wsnet-primary-dark); font-size: 14px;">Adicionar Novo Dependente</h4>
                    <div class="form-group">
                        <label class="form-label">Nome do Dependente *</label>
                        <input type="text" class="form-control" id="novoDependenteNome" placeholder="Nome completo">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Parentesco *</label>
                        <select class="form-control" id="novoDependenteParentesco">
                            <option value="">Selecione...</option>
                            <option value="Cônjuge">Cônjuge</option>
                            <option value="Filho(a)">Filho(a)</option>
                            <option value="Pai/Mãe">Pai/Mãe</option>
                            <option value="Irmão(ã)">Irmão(ã)</option>
                            <option value="Outro Familiar">Outro Familiar</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary btn-block" onclick="adicionarNovoDependente()">
                        <span class="material-icons">add</span>
                        Adicionar Dependente
                    </button>
                </div>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--wsnet-border);">
                    <p style="font-size: 14px; color: var(--wsnet-text-medium);">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle;">info</span>
                        Limite: <span id="contadorDependentes">0</span>/3 dependentes
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('modalColaborador')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarColaboradorFirebase()" id="btnSalvarColaborador">
                    <span class="material-icons">save</span>
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Gerenciar Departamentos -->
    <div id="modalDepartamentos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gerenciar Departamentos</h3>
                <span class="material-icons" style="cursor: pointer;" onclick="closeModal('modalDepartamentos')">close</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Adicionar Novo Departamento:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="novoDepartamento" placeholder="Nome do departamento">
                        <button type="button" class="btn btn-primary" onclick="adicionarDepartamento()">
                            <span class="material-icons">add</span>
                        </button>
                    </div>
                </div>

                <h4 style="margin: 20px 0 10px 0; color: var(--wsnet-primary-dark);">Departamentos Cadastrados</h4>
                <div id="listaDepartamentos" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                    <p style="color: var(--wsnet-text-light); text-align: center; padding: 20px; grid-column: 1 / -1;">
                        Carregando departamentos...
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('modalDepartamentos')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Gerenciar Empresas -->
    <div id="modalEmpresas" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gerenciar Empresas</h3>
                <span class="material-icons" style="cursor: pointer;" onclick="closeModal('modalEmpresas')">close</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Adicionar Nova Empresa:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="novaEmpresa" placeholder="Nome da empresa">
                        <button type="button" class="btn btn-primary" onclick="adicionarEmpresaFirebase()">
                            <span class="material-icons">add</span>
                        </button>
                    </div>
                </div>

                <h4 style="margin: 20px 0 10px 0; color: var(--wsnet-primary-dark);">Empresas Cadastradas</h4>
                <div id="listaEmpresas" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                    <p style="color: var(--wsnet-text-light); text-align: center; padding: 20px; grid-column: 1 / -1;">
                        Carregando empresas...
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('modalEmpresas')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Iniciar Novo Mês -->
    <div id="modalNovoMes" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Iniciar Novo Mês</h3>
                <span class="material-icons" style="cursor: pointer;" onclick="closeModal('modalNovoMes')">close</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--wsnet-text-medium);">Ao iniciar um novo mês, o sistema irá:</p>
                <ul style="margin-bottom: 20px; padding-left: 20px; color: var(--wsnet-text-medium);">
                    <li>Salvar todas as retiradas do mês atual no histórico</li>
                    <li>Zerar as retiradas para o novo mês</li>
                    <li>Manter todos os colaboradores e dependentes</li>
                    <li>Todos os colaboradores ficarão como PENDENTES para o novo mês</li>
                </ul>
                
                <div class="form-group">
                    <label class="form-label">Mês Atual (que será fechado):</label>
                    <div style="padding: 12px; background: var(--wsnet-bg-light); border-radius: var(--radius-md); color: var(--wsnet-primary-dark);">
                        <strong id="mesAtualLabel"></strong>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Selecione o Próximo Mês:</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <select class="form-control" style="flex: 1; min-width: 150px;" id="novoMesSelecionado">
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">Março</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">Julho</option>
                            <option value="08">Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                        <input type="number" class="form-control" style="flex: 1; min-width: 120px;" id="novoAnoSelecionado" placeholder="2025" min="2020" max="2100">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('modalNovoMes')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarNovoMes()">Iniciar Novo Mês</button>
            </div>
        </div>
    </div>

    <!-- Modal Limpar Retiradas -->
    <div id="modalLimparRetiradas" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Limpar Todas as Retiradas</h3>
                <span class="material-icons" style="cursor: pointer;" onclick="closeModal('modalLimparRetiradas')">close</span>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" style="display: block; margin-bottom: 20px; padding: 16px; border-radius: var(--radius-md);">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 8px; color: var(--wsnet-warning);">warning</span>
                    <strong>ATENÇÃO:</strong> Esta ação não pode ser desfeita!
                </div>
                
                <p style="margin-bottom: 15px; color: var(--wsnet-text-medium);">Ao limpar as retiradas, o sistema irá:</p>
                <ul style="margin-bottom: 20px; padding-left: 20px; color: var(--wsnet-text-medium);">
                    <li><strong>Apagar TODAS as retiradas registradas</strong></li>
                    <li><strong>Limpar todo o histórico de retiradas</strong></li>
                    <li>Manter todos os colaboradores cadastrados</li>
                    <li>Manter todos os departamentos</li>
                    <li>Manter a configuração do mês atual</li>
                    <li>Todos os colaboradores ficarão como PENDENTES</li>
                </ul>
                
                <div class="form-group">
                    <label class="form-label">Digite "LIMPAR" para confirmar:</label>
                    <input type="text" class="form-control" id="confirmacaoLimpar" placeholder="Digite LIMPAR aqui" style="text-transform: uppercase;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('modalLimparRetiradas')">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarLimpezaRetiradas()" id="btnConfirmarLimpeza" disabled>
                    <span class="material-icons">delete_forever</span>
                    Limpar Tudo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Retirada -->
    <div id="modalRetirada" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Registrar Retirada</h3>
                <span class="material-icons" style="cursor: pointer;" onclick="closeModal('modalRetirada')">close</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--wsnet-text-medium);">Para: <strong id="titularRetirada" style="color: var(--wsnet-primary-dark);"></strong></p>
                
                <h4 style="margin-bottom: 16px; color: var(--wsnet-primary-dark); font-size: 14px;">Quem está retirando?</h4>
                <div id="listaAutorizados"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('modalRetirada')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes Retirada -->
    <div id="modalDetalhesRetirada" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalhes da Retirada</h3>
                <span class="material-icons" style="cursor: pointer;" onclick="closeModal('modalDetalhesRetirada')">close</span>
            </div>
            <div class="modal-body">
                <div id="detalhesRetiradaConteudo">
                    <!-- Conteúdo será preenchido via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('modalDetalhesRetirada')">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="imprimirRecibo()">
                    <span class="material-icons">print</span>
                    Imprimir Recibo
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmação de Retirada -->
    <div id="confirmacaoRetirada" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-body" style="text-align: center; padding: 40px;">
                <div style="font-size: 60px; color: var(--wsnet-warning); margin-bottom: 20px;">
                    <span class="material-icons">question_answer</span>
                </div>
                <h3 id="confirmacaoTitulo" style="margin-bottom: 16px; color: var(--wsnet-primary-dark);">Confirmar Retirada</h3>
                <p id="confirmacaoMensagem" style="color: var(--wsnet-text-medium); margin-bottom: 30px;"></p>
                <div style="display: flex; gap: 16px; justify-content: center;">
                    <button type="button" class="btn btn-outline" onclick="cancelarConfirmacao()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarRetirada()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cancelar Retirada -->
    <div id="modalCancelarRetirada" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Cancelar Retirada</h3>
                <span class="material-icons" style="cursor: pointer;" onclick="closeModal('modalCancelarRetirada')">close</span>
            </div>
            <div class="modal-body">
                <div id="listaRetiradasParaCancelar">
                    <!-- Lista de retiradas será preenchida via JavaScript -->
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label">Motivo do Cancelamento:</label>
                    <textarea class="form-control" id="motivoCancelamento" rows="3" placeholder="Digite o motivo do cancelamento..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('modalCancelarRetirada')">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarCancelamentoRetirada()">
                    <span class="material-icons">delete</span>
                    Cancelar Retirada
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== SISTEMA COMPLETO ====================
        let currentUser = null;
        let colaboradorSelecionado = null;
        let dependentesEditando = [];
        let modoEdicao = false;
        let retiradaPendente = null;
        let charts = {};
        let ultimaRetiradaRegistrada = null;
        let colaboradoresLista = [];
        let retiradasLista = [];
        let empresasLista = [];
        let escutaColaboradoresAtiva = false;
        let escutaRetiradasAtiva = false;
        let escutaEmpresasAtiva = false;
        let retiradaParaCancelar = null;
        
        // IMPORTANTE: Agora o mês atual é carregado do localStorage sempre que o sistema inicia
        let mesAtual = null; // Será carregado após login

        // ==================== BANCO DE DADOS LOCAL ====================
        class LocalDatabase {
            constructor() {
                this.initDatabase();
            }

            initDatabase() {
                if (!localStorage.getItem('config')) {
                    localStorage.setItem('config', JSON.stringify({
                        mesAtual: new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0'),
                        empresaNome: 'WSNET TELECOM',
                        empresaEndereco: 'Rua Exemplo, 123 - Centro',
                        empresaTelefone: '(11) 99999-9999'
                    }));
                }
                
                if (!localStorage.getItem('departamentos')) {
                    localStorage.setItem('departamentos', JSON.stringify([
                        'Administração', 'Comercial', 'Financeiro', 'Recursos Humanos',
                        'Produção', 'Logística', 'TI', 'Manutenção', 'Qualidade', 'Segurança'
                    ].sort((a, b) => a.localeCompare(b))));
                }
                
                if (!localStorage.getItem('historicoRetiradas')) {
                    localStorage.setItem('historicoRetiradas', JSON.stringify([]));
                }
                
                this.initUsuarios();
            }

            initUsuarios() {
                const usuariosPadrao = [
                    {
                        email: 'gente.gestao@email.com',
                        senha: 'wsnet1205*',
                        role: 'admin',
                        nome: 'Administrador'
                    },
                    // 7 usuários com acesso apenas às retiradas (role 'registrador')
                    {
                        email: 'vinicius.mekacheski@email.com',
                        senha: 'wsnet1205',
                        role: 'registrador',
                        nome: 'Vinicius Mekacheski'
                    },
                    {
                        email: 'alexandre.chariff@email.com',
                        senha: 'wsnet1205',
                        role: 'registrador',
                        nome: 'Alexandre Chariff'
                    },
                    {
                        email: 'jonathan.cristian@email.com',
                        senha: 'wsnet1205',
                        role: 'registrador',
                        nome: 'Jonathan Cristian'
                    },
                    {
                        email: 'douglas.tadeu@email.com',
                        senha: 'wsnet1205',
                        role: 'registrador',
                        nome: 'Douglas Tadeu'
                    },
                    {
                        email: 'everton.fraga@email.com',
                        senha: 'wsnet1205',
                        role: 'registrador',
                        nome: 'Everton Fraga'
                    },
                    {
                        email: 'douglas.farias@email.com',
                        senha: 'wsnet1205',
                        role: 'registrador',
                        nome: 'Douglas Farias'
                    },
                    {
                        email: 'rogerio.pereira@email.com',
                        senha: 'wsnet1205',
                        role: 'registrador',
                        nome: 'Rogerio Pereira'
                    }
                ];

                let usuarios = [];
                
                if (localStorage.getItem('usuarios')) {
                    try {
                        usuarios = JSON.parse(localStorage.getItem('usuarios'));
                    } catch (error) {
                        usuarios = [];
                    }
                }
                
                // Remover o usuário antigo 'retirada@email.com' se existir
                usuarios = usuarios.filter(u => u.email !== 'retirada@email.com');
                
                // Adicionar os novos usuários se não existirem
                usuariosPadrao.forEach(usuarioPadrao => {
                    const existe = usuarios.find(u => u.email.toLowerCase() === usuarioPadrao.email.toLowerCase());
                    if (!existe) {
                        usuarios.push(usuarioPadrao);
                    }
                });
                
                localStorage.setItem('usuarios', JSON.stringify(usuarios));
            }

            getMesAtual() {
                const config = this.getConfig();
                return config.mesAtual;
            }

            setMesAtual(mes) {
                const config = this.getConfig();
                config.mesAtual = mes;
                localStorage.setItem('config', JSON.stringify(config));
                mesAtual = mes; // Atualiza a variável global também
            }

            getConfig() {
                try {
                    return JSON.parse(localStorage.getItem('config')) || {
                        mesAtual: new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0'),
                        empresaNome: 'WSNET TELECOM',
                        empresaEndereco: 'Rua Exemplo, 123 - Centro',
                        empresaTelefone: '(11) 99999-9999'
                    };
                } catch (error) {
                    return {
                        mesAtual: new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0'),
                        empresaNome: 'WSNET TELECOM',
                        empresaEndereco: 'Rua Exemplo, 123 - Centro',
                        empresaTelefone: '(11) 99999-9999'
                    };
                }
            }

            getDepartamentos() {
                try {
                    const departamentos = JSON.parse(localStorage.getItem('departamentos')) || [];
                    return departamentos.sort((a, b) => a.localeCompare(b));
                } catch (error) {
                    return [];
                }
            }

            adicionarDepartamento(novoDepartamento) {
                const departamentos = this.getDepartamentos();
                if (novoDepartamento && !departamentos.includes(novoDepartamento.trim())) {
                    departamentos.push(novoDepartamento.trim());
                    const departamentosOrdenados = departamentos.sort((a, b) => a.localeCompare(b));
                    localStorage.setItem('departamentos', JSON.stringify(departamentosOrdenados));
                    return true;
                }
                return false;
            }

            removerDepartamento(departamento) {
                let departamentos = this.getDepartamentos();
                const index = departamentos.indexOf(departamento);
                if (index !== -1) {
                    departamentos.splice(index, 1);
                    localStorage.setItem('departamentos', JSON.stringify(departamentos));
                    return true;
                }
                return false;
            }

            getUsuarios() {
                try {
                    return JSON.parse(localStorage.getItem('usuarios')) || [];
                } catch (error) {
                    return [];
                }
            }

            buscarUsuario(email, senha) {
                email = email ? email.trim().toLowerCase() : '';
                senha = senha ? senha.trim() : '';
                
                const usuarios = this.getUsuarios();
                if (usuarios.length === 0) return null;
                
                return usuarios.find(u => {
                    return u.email.toLowerCase() === email && u.senha === senha;
                });
            }

            // Função para verificar se usuário está logado
            getLoggedInUser() {
                try {
                    return JSON.parse(localStorage.getItem('loggedInUser'));
                } catch (error) {
                    return null;
                }
            }

            setLoggedInUser(user) {
                localStorage.setItem('loggedInUser', JSON.stringify(user));
            }

            clearLoggedInUser() {
                localStorage.removeItem('loggedInUser');
            }
        }

        // ==================== FUNÇÕES RESPONSIVAS ====================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function handleResize() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const mainContent = document.querySelector('.main-content');
            
            if (window.innerWidth > 1024) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                mainContent.style.marginLeft = '250px';
            } else {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                mainContent.style.marginLeft = '0';
            }
        }

        window.addEventListener('resize', handleResize);

        // ==================== FUNÇÕES DE LOGIN ====================
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            currentUser = null;
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            inicializarAbas();
            document.getElementById('pageTitle').textContent = 'Dashboard';
            document.getElementById('pageIcon').textContent = 'dashboard';
            
            try {
                if (window.firebaseInitialized) {
                    iniciarEscutaColaboradoresEmTempoReal();
                    iniciarEscutaRetiradasEmTempoReal();
                    iniciarEscutaEmpresasEmTempoReal();
                }
            } catch (error) {
                console.error('Erro ao iniciar escutas Firebase:', error);
            }
            
            // Carregar dashboard com o mês atual persistido
            carregarDashboard();
            handleResize();
        }

        function login(email, password) {
            const btnLogin = document.getElementById('btnLogin');
            const originalText = btnLogin.innerHTML;
            
            btnLogin.innerHTML = '<span class="material-icons">loop</span> Entrando...';
            btnLogin.disabled = true;
            
            const loginAlert = document.getElementById('loginAlert');
            if (loginAlert) {
                loginAlert.style.display = 'none';
            }

            setTimeout(() => {
                try {
                    if (!email || !password) {
                        showLoginAlert('Por favor, preencha email e senha!', 'error');
                        btnLogin.innerHTML = originalText;
                        btnLogin.disabled = false;
                        return;
                    }
                    
                    const db = new LocalDatabase();
                    const usuario = db.buscarUsuario(email, password);
                    
                    if (usuario) {
                        currentUser = usuario;
                        
                        // Salvar usuário logado no localStorage
                        db.setLoggedInUser(usuario);
                        
                        // IMPORTANTE: Carregar o mês atual do localStorage
                        mesAtual = db.getMesAtual();
                        console.log('Mês atual carregado do localStorage:', mesAtual);
                        
                        document.getElementById('userName').textContent = usuario.nome;
                        document.getElementById('userRole').textContent = usuario.role === 'admin' ? 'Admin' : 'Registrador';
                        document.getElementById('userRole').className = 'user-role';

                        setupUserPermissions();
                        showMainApp();
                        showAlert(`Bem-vindo, ${usuario.nome}!`, 'success');
                    } else {
                        showLoginAlert('Email ou senha incorretos!', 'error');
                    }
                    
                } catch (error) {
                    console.error('ERRO DURANTE O LOGIN:', error);
                    showLoginAlert('Erro ao fazer login. Tente novamente.', 'error');
                } finally {
                    btnLogin.innerHTML = originalText;
                    btnLogin.disabled = false;
                }
            }, 500);
        }

        // Verificar se usuário já está logado ao carregar a página
        function checkLoggedInUser() {
            const db = new LocalDatabase();
            const loggedInUser = db.getLoggedInUser();
            
            if (loggedInUser) {
                currentUser = loggedInUser;
                
                // IMPORTANTE: Carregar o mês atual do localStorage
                mesAtual = db.getMesAtual();
                console.log('Mês atual carregado do localStorage:', mesAtual);
                
                document.getElementById('userName').textContent = loggedInUser.nome;
                document.getElementById('userRole').textContent = loggedInUser.role === 'admin' ? 'Admin' : 'Registrador';
                document.getElementById('userRole').className = 'user-role';

                setupUserPermissions();
                showMainApp();
            } else {
                showLoginScreen();
            }
        }

        function setupUserPermissions() {
            const adminButtons = document.getElementById('adminButtons');
            const menuItems = document.querySelectorAll('.menu-item');
            
            if (currentUser.role === 'admin') {
                if (adminButtons) adminButtons.style.display = 'flex';
                menuItems.forEach(item => item.style.display = 'flex');
            } else if (currentUser.role === 'registrador') {
                if (adminButtons) adminButtons.style.display = 'none';
                menuItems.forEach(item => {
                    if (!item.textContent.includes('Retiradas')) {
                        item.style.display = 'none';
                    } else {
                        item.style.display = 'flex';
                    }
                });
                
                showTab('retirada');
            }
        }

        function logout() {
            const db = new LocalDatabase();
            db.clearLoggedInUser();
            
            currentUser = null;
            colaboradoresLista = [];
            retiradasLista = [];
            empresasLista = [];
            escutaColaboradoresAtiva = false;
            escutaRetiradasAtiva = false;
            escutaEmpresasAtiva = false;
            showLoginScreen();
            showLoginAlert('Você saiu do sistema.', 'success');
        }

        function showLoginAlert(message, type = 'error') {
            const alert = document.getElementById('loginAlert');
            if (!alert) return;
            
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // ==================== FUNÇÕES BÁSICAS ====================
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            if (!alert) return;
            
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function getTabDisplayName(tabName) {
            const names = {
                'dashboard': 'Dashboard',
                'retirada': 'Retiradas',
                'colaboradores': 'Colaboradores',
                'relatorios': 'Relatórios'
            };
            return names[tabName] || tabName;
        }

        function inicializarAbas() {
            const abas = ['dashboard', 'retirada', 'colaboradores', 'relatorios'];
            abas.forEach(aba => {
                const element = document.getElementById(aba);
                if (element) {
                    element.classList.remove('active');
                }
            });
            
            document.getElementById('dashboard').classList.add('active');
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                const span = item.querySelector('span:not(.material-icons)');
                if (span && span.textContent.trim() === 'Dashboard') {
                    item.classList.add('active');
                }
            });
        }

        // ==================== FUNÇÕES DE NAVEGAÇÃO ====================
        function showTab(tabName) {
            if (currentUser && currentUser.role === 'registrador' && tabName !== 'retirada') {
                showAlert('Acesso restrito! Você só pode acessar a aba de Retiradas.', 'error');
                return;
            }
            
            if (window.innerWidth <= 1024) {
                toggleSidebar();
            }
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                const span = item.querySelector('span:not(.material-icons)');
                if (span) {
                    const itemText = span.textContent.trim();
                    const tabDisplayName = getTabDisplayName(tabName);
                    if (itemText === tabDisplayName) {
                        item.classList.add('active');
                    }
                }
            });
            
            const tabElement = document.getElementById(tabName);
            if (tabElement) {
                tabElement.classList.add('active');
            } else {
                console.error('Tab não encontrada:', tabName);
                return;
            }

            const pageTitles = {
                'dashboard': { title: 'Dashboard', icon: 'dashboard' },
                'retirada': { title: 'Retiradas', icon: 'shopping_cart' },
                'colaboradores': { title: 'Colaboradores', icon: 'group' },
                'relatorios': { title: 'Relatórios', icon: 'assessment' }
            };
            
            if (pageTitles[tabName]) {
                document.getElementById('pageTitle').textContent = pageTitles[tabName].title;
                document.getElementById('pageIcon').textContent = pageTitles[tabName].icon;
            }

            if (tabName === 'dashboard') {
                carregarDashboard();
            } else if (tabName === 'retirada') {
                carregarRetirada();
            } else if (tabName === 'colaboradores') {
                carregarColaboradores();
            } else if (tabName === 'relatorios') {
                carregarMesAnoAtual();
                setTimeout(() => {
                    carregarRelatorio();
                }, 300);
            }
        }

        // ==================== FUNÇÕES FIREBASE ====================
        async function carregarColaboradoresDoFirebase() {
            try {
                const db = window.firebaseDb;
                const { collection, getDocs } = window.firebaseCollections;
                
                const querySnapshot = await getDocs(collection(db, "colaboradores"));
                const colaboradoresFirebase = [];
                
                querySnapshot.forEach((doc) => {
                    colaboradoresFirebase.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                colaboradoresFirebase.sort((a, b) => a.nome.localeCompare(b.nome));
                
                colaboradoresLista = colaboradoresFirebase;
                
                atualizarFiltrosEmpresa();
                atualizarDistribuicaoCidade();
                
                if (document.getElementById('colaboradores').classList.contains('active')) {
                    carregarColaboradores();
                }
                
                if (document.getElementById('retirada').classList.contains('active')) {
                    carregarRetirada();
                }
                
                carregarDashboard();
                
                return colaboradoresFirebase;
            } catch (erro) {
                console.error("Erro ao carregar do Firebase:", erro);
                showAlert('Erro ao carregar lista de colaboradores. Verifique a conexão.', 'error');
                return [];
            }
        }

        async function salvarColaboradorFirebase() {
            try {
                const nome = document.getElementById('nomeColaborador').value.trim();
                const empresa = document.getElementById('empresaColaborador').value;
                const cidade = document.getElementById('cidadeColaborador').value;
                const departamento = document.getElementById('departamentoColaborador').value;
                const status = document.getElementById('statusColaborador').value;
                const colaboradorId = document.getElementById('colaboradorId').value;

                if (!nome || !empresa || !cidade || !departamento || !status) {
                    showAlert('Preencha todos os campos obrigatórios!', 'error');
                    return;
                }

                const colaboradorData = {
                    nome: nome,
                    empresa: empresa,
                    cidade: cidade,
                    departamento: departamento,
                    status: status,
                    dependentes: [...dependentesEditando],
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser?.email || "Sistema"
                };

                const db = window.firebaseDb;
                const { collection, addDoc, doc, updateDoc } = window.firebaseCollections;
                
                if (colaboradorId) {
                    // Modo edição
                    const docRef = doc(db, "colaboradores", colaboradorId);
                    await updateDoc(docRef, colaboradorData);
                    showAlert('Colaborador atualizado com sucesso!', 'success');
                } else {
                    // Novo colaborador
                    colaboradorData.createdAt = new Date().toISOString();
                    colaboradorData.createdBy = currentUser?.email || "Sistema";
                    await addDoc(collection(db, "colaboradores"), colaboradorData);
                    showAlert('Colaborador cadastrado com sucesso!', 'success');
                }

                closeModal("modalColaborador");
                document.getElementById("formColaborador").reset();
                dependentesEditando = [];
                
            } catch (erro) {
                console.error("Erro ao salvar no Firebase:", erro);
                showAlert('Erro ao conectar com o banco de dados.', 'error');
            }
        }

        async function excluirColaboradorFirebase(colaboradorId) {
            if (!confirm('Tem certeza que deseja excluir este colaborador?\n\nEsta ação não pode ser desfeita e excluirá também todos os seus dependentes.')) {
                return;
            }

            try {
                const db = window.firebaseDb;
                const { doc, deleteDoc } = window.firebaseCollections;
                
                const docRef = doc(db, "colaboradores", colaboradorId);
                await deleteDoc(docRef);
                showAlert('Colaborador excluído com sucesso!', 'success');
            } catch (erro) {
                console.error("Erro ao excluir:", erro);
                showAlert('Erro ao excluir colaborador.', 'error');
            }
        }

        async function toggleStatusColaborador(colaboradorId, novoStatus) {
            try {
                const db = window.firebaseDb;
                const { doc, updateDoc } = window.firebaseCollections;
                
                const docRef = doc(db, "colaboradores", colaboradorId);
                await updateDoc(docRef, {
                    status: novoStatus,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser?.email || "Sistema"
                });
                
                showAlert(`Colaborador ${novoStatus === 'ativo' ? 'ativado' : 'inativado'} com sucesso!`, 'success');
                return true;
            } catch (erro) {
                console.error("Erro ao alterar status do colaborador:", erro);
                showAlert('Erro ao alterar status do colaborador.', 'error');
                return false;
            }
        }

        function iniciarEscutaColaboradoresEmTempoReal() {
            if (escutaColaboradoresAtiva) return;
            
            try {
                const db = window.firebaseDb;
                const { collection, onSnapshot } = window.firebaseCollections;
                
                const colaboradoresCollection = collection(db, "colaboradores");
                
                onSnapshot(colaboradoresCollection, (querySnapshot) => {
                    const colaboradoresFirebase = [];
                    querySnapshot.forEach((doc) => {
                        colaboradoresFirebase.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    colaboradoresFirebase.sort((a, b) => a.nome.localeCompare(b.nome));
                    
                    colaboradoresLista = colaboradoresFirebase;
                    
                    atualizarFiltrosEmpresa();
                    atualizarDistribuicaoCidade();
                    
                    if (document.getElementById('colaboradores').classList.contains('active')) {
                        carregarColaboradores();
                    }
                    
                    if (document.getElementById('retirada').classList.contains('active')) {
                        carregarRetirada();
                    }
                    
                    carregarDashboard();
                    
                    escutaColaboradoresAtiva = true;
                }, (erro) => {
                    console.error("Erro na escuta de colaboradores:", erro);
                    escutaColaboradoresAtiva = false;
                });
                
            } catch (erro) {
                console.error("Erro ao iniciar escuta de colaboradores:", erro);
            }
        }

        async function carregarRetiradasDoFirebase() {
            try {
                const db = window.firebaseDb;
                const { collection, getDocs } = window.firebaseCollections;
                
                const querySnapshot = await getDocs(collection(db, "retiradas"));
                const retiradasFirebase = [];
                
                querySnapshot.forEach((doc) => {
                    retiradasFirebase.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                const retiradasMes = retiradasFirebase.filter(r => r.mesReferencia === mesAtual);
                
                retiradasMes.sort((a, b) => new Date(b.dataRetirada) - new Date(a.dataRetirada));
                
                retiradasLista = retiradasMes;
                
                return retiradasMes;
            } catch (erro) {
                console.error("Erro ao carregar retiradas:", erro);
                showAlert('Erro ao carregar lista de retiradas.', 'error');
                return [];
            }
        }

        function iniciarEscutaRetiradasEmTempoReal() {
            if (escutaRetiradasAtiva) return;
            
            try {
                const db = window.firebaseDb;
                const { collection, onSnapshot } = window.firebaseCollections;
                
                const retiradasCollection = collection(db, "retiradas");
                
                onSnapshot(retiradasCollection, (querySnapshot) => {
                    const retiradasFirebase = [];
                    querySnapshot.forEach((doc) => {
                        retiradasFirebase.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    const retiradasMes = retiradasFirebase.filter(r => r.mesReferencia === mesAtual);
                    
                    retiradasMes.sort((a, b) => new Date(b.dataRetirada) - new Date(a.dataRetirada));
                    
                    retiradasLista = retiradasMes;
                    
                    if (document.getElementById('retirada').classList.contains('active')) {
                        carregarRetirada();
                    }
                    
                    carregarDashboard();
                    
                    escutaRetiradasAtiva = true;
                }, (erro) => {
                    console.error("Erro na escuta de retiradas:", erro);
                    escutaRetiradasAtiva = false;
                });
                
            } catch (erro) {
                console.error("Erro ao iniciar escuta de retiradas:", erro);
            }
        }

        async function registrarRetiradaFirebase(retirada) {
            try {
                const db = window.firebaseDb;
                const { collection, addDoc } = window.firebaseCollections;
                
                await addDoc(collection(db, "retiradas"), retirada);
                return true;
            } catch (erro) {
                console.error("Erro ao salvar retirada:", erro);
                return false;
            }
        }

        async function cancelarRetiradaFirebase(retiradaId, motivo) {
            try {
                const db = window.firebaseDb;
                const { doc, deleteDoc } = window.firebaseCollections;
                
                const docRef = doc(db, "retiradas", retiradaId);
                await deleteDoc(docRef);
                
                // Registrar no histórico
                const historico = JSON.parse(localStorage.getItem('historicoRetiradas') || '[]');
                historico.push({
                    data: new Date().toISOString(),
                    acao: 'Cancelamento de retirada',
                    retiradaId: retiradaId,
                    motivo: motivo,
                    realizadoPor: currentUser?.email || 'Sistema'
                });
                localStorage.setItem('historicoRetiradas', JSON.stringify(historico));
                
                return true;
            } catch (erro) {
                console.error("Erro ao cancelar retirada:", erro);
                return false;
            }
        }

        async function limparTodasRetiradasFirebase() {
            try {
                const db = window.firebaseDb;
                const { collection, getDocs, deleteDoc, doc } = window.firebaseCollections;
                
                const querySnapshot = await getDocs(collection(db, "retiradas"));
                const deletePromises = [];
                querySnapshot.forEach((document) => {
                    deletePromises.push(deleteDoc(doc(db, "retiradas", document.id)));
                });
                
                await Promise.all(deletePromises);
                return true;
            } catch (erro) {
                console.error("Erro ao limpar retiradas:", erro);
                return false;
            }
        }

        // ==================== FUNÇÕES FIREBASE PARA EMPRESAS ====================
        async function carregarEmpresasDoFirebase() {
            try {
                const db = window.firebaseDb;
                const { collection, getDocs } = window.firebaseCollections;
                
                const querySnapshot = await getDocs(collection(db, "empresas"));
                const empresasFirebase = [];
                
                querySnapshot.forEach((doc) => {
                    empresasFirebase.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                empresasFirebase.sort((a, b) => a.nome.localeCompare(b.nome));
                
                empresasLista = empresasFirebase.map(e => e.nome);
                
                atualizarFiltrosEmpresa();
                
                if (document.getElementById('modalEmpresas').style.display === 'block') {
                    carregarListaEmpresas();
                }
                
                return empresasFirebase;
            } catch (erro) {
                console.error("Erro ao carregar empresas do Firebase:", erro);
                showAlert('Erro ao carregar lista de empresas. Verifique a conexão.', 'error');
                return [];
            }
        }

        async function adicionarEmpresaFirebase() {
            const input = document.getElementById('novaEmpresa');
            const novaEmpresa = input.value.trim();
            
            if (!novaEmpresa) {
                showAlert('Digite o nome da empresa!', 'error');
                return;
            }

            try {
                const db = window.firebaseDb;
                const { collection, addDoc } = window.firebaseCollections;
                
                if (empresasLista.includes(novaEmpresa)) {
                    showAlert('Esta empresa já existe!', 'error');
                    return;
                }
                
                const empresaData = {
                    nome: novaEmpresa,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser?.email || "Sistema"
                };
                
                await addDoc(collection(db, "empresas"), empresaData);
                showAlert(`Empresa "${novaEmpresa}" adicionada com sucesso!`, 'success');
                input.value = '';
                
            } catch (erro) {
                console.error("Erro ao adicionar empresa no Firebase:", erro);
                showAlert('Erro ao adicionar empresa. Tente novamente.', 'error');
            }
        }

        async function removerEmpresaFirebase(empresaNome) {
            if (!confirm(`Tem certeza que deseja remover a empresa "${empresaNome}"?\n\nEsta ação não afetará os colaboradores já cadastrados, mas novos colaboradores não poderão selecionar esta empresa.`)) {
                return;
            }

            try {
                const db = window.firebaseDb;
                const { collection, getDocs, query, where, deleteDoc, doc } = window.firebaseCollections;
                
                const empresasRef = collection(db, "empresas");
                const q = query(empresasRef, where("nome", "==", empresaNome));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const deletePromises = [];
                    querySnapshot.forEach((document) => {
                        deletePromises.push(deleteDoc(doc(db, "empresas", document.id)));
                    });
                    
                    await Promise.all(deletePromises);
                    showAlert(`Empresa "${empresaNome}" removida com sucesso!`, 'success');
                } else {
                    showAlert('Empresa não encontrada no banco de dados.', 'error');
                }
                
            } catch (erro) {
                console.error("Erro ao remover empresa do Firebase:", erro);
                showAlert('Erro ao remover empresa. Tente novamente.', 'error');
            }
        }

        function iniciarEscutaEmpresasEmTempoReal() {
            if (escutaEmpresasAtiva) return;
            
            try {
                const db = window.firebaseDb;
                const { collection, onSnapshot } = window.firebaseCollections;
                
                const empresasCollection = collection(db, "empresas");
                
                onSnapshot(empresasCollection, (querySnapshot) => {
                    const empresasFirebase = [];
                    querySnapshot.forEach((doc) => {
                        empresasFirebase.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    empresasFirebase.sort((a, b) => a.nome.localeCompare(b.nome));
                    
                    empresasLista = empresasFirebase.map(e => e.nome);
                    
                    atualizarFiltrosEmpresa();
                    
                    if (document.getElementById('modalEmpresas').style.display === 'block') {
                        carregarListaEmpresas();
                    }
                    
                    escutaEmpresasAtiva = true;
                }, (erro) => {
                    console.error("Erro na escuta de empresas:", erro);
                    escutaEmpresasAtiva = false;
                });
                
            } catch (erro) {
                console.error("Erro ao iniciar escuta de empresas:", erro);
            }
        }

        // ==================== FUNÇÕES DE FILTRO ====================
        function atualizarFiltrosEmpresa() {
            const empresas = empresasLista;
            
            const filtrosIds = [
                'filtroEmpresaDashboard',
                'filtroEmpresaRetirada',
                'filtroEmpresaColaboradores',
                'empresaRelatorio',
                'empresaColaborador'
            ];
            
            filtrosIds.forEach(filtroId => {
                const select = document.getElementById(filtroId);
                if (select) {
                    let options = filtroId === 'empresaRelatorio' || filtroId.includes('filtro') 
                        ? '<option value="todas">Todas as Empresas</option>'
                        : '<option value="">Selecione a empresa...</option>';
                    
                    empresas.forEach(empresa => {
                        options += `<option value="${empresa}">${empresa}</option>`;
                    });
                    
                    select.innerHTML = options;
                }
            });
        }

        function filtrarPorEmpresaECidade(colaboradores, empresaSelecionada, cidadeSelecionada) {
            let filtrados = [...colaboradores];
            
            // Filtrar apenas colaboradores ativos (para retiradas)
            filtrados = filtrados.filter(c => c.status !== 'inativo');
            
            if (empresaSelecionada !== 'todas' && empresaSelecionada) {
                filtrados = filtrados.filter(c => c.empresa === empresaSelecionada);
            }
            
            if (cidadeSelecionada !== 'todas' && cidadeSelecionada) {
                filtrados = filtrados.filter(c => c.cidade === cidadeSelecionada);
            }
            
            return filtrados;
        }

        // ==================== FUNÇÕES DE EXPORTAÇÃO COM FILTROS ====================
        function obterColaboradoresFiltrados() {
            const empresaSelecionada = document.getElementById('filtroEmpresaColaboradores').value;
            const cidadeSelecionada = document.getElementById('filtroCidadeColaboradores').value;
            const statusSelecionado = document.getElementById('filtroStatusColaboradores').value;
            const search = document.getElementById('searchColaborador').value.toLowerCase();
            
            let filtrados = [...colaboradoresLista];
            
            // Aplicar filtro de status
            if (statusSelecionado === 'ativo') {
                filtrados = filtrados.filter(c => c.status === 'ativo');
            } else if (statusSelecionado === 'inativo') {
                filtrados = filtrados.filter(c => c.status === 'inativo');
            }
            // Se for 'todos', não filtra por status
            
            // Aplicar filtro de empresa
            if (empresaSelecionada !== 'todas') {
                filtrados = filtrados.filter(c => c.empresa === empresaSelecionada);
            }
            
            // Aplicar filtro de cidade
            if (cidadeSelecionada !== 'todas') {
                filtrados = filtrados.filter(c => c.cidade === cidadeSelecionada);
            }
            
            // Aplicar filtro de busca
            if (search) {
                filtrados = filtrados.filter(colaborador => 
                    colaborador.nome.toLowerCase().includes(search) ||
                    (colaborador.departamento && colaborador.departamento.toLowerCase().includes(search)) ||
                    (colaborador.empresa && colaborador.empresa.toLowerCase().includes(search)) ||
                    (colaborador.cidade && colaborador.cidade.toLowerCase().includes(search))
                );
            }
            
            return filtrados;
        }

        function atualizarContadorColaboradores() {
            const colaboradoresFiltrados = obterColaboradoresFiltrados();
            const contadorElement = document.getElementById('contadorColaboradoresFiltrados');
            
            if (contadorElement && colaboradoresLista.length > 0) {
                const totalFiltrado = colaboradoresFiltrados.length;
                const totalGeral = colaboradoresLista.length;
                const statusSelecionado = document.getElementById('filtroStatusColaboradores').value;
                
                let statusText = '';
                if (statusSelecionado === 'ativo') {
                    statusText = ' (Ativos)';
                } else if (statusSelecionado === 'inativo') {
                    statusText = ' (Inativos)';
                } else {
                    statusText = ' (Todos)';
                }
                
                if (totalFiltrado === totalGeral) {
                    contadorElement.textContent = `Total: ${totalGeral}${statusText}`;
                } else {
                    contadorElement.textContent = `Mostrando ${totalFiltrado} de ${totalGeral}${statusText}`;
                }
            }
        }

        // ==================== DASHBOARD ====================
        function carregarDashboard() {
            const empresaSelecionada = document.getElementById('filtroEmpresaDashboard').value;
            const cidadeSelecionada = document.getElementById('filtroCidadeDashboard').value;
            const colaboradoresFiltrados = filtrarPorEmpresaECidade(colaboradoresLista, empresaSelecionada, cidadeSelecionada);
            const retiradasFiltradas = retiradasLista.filter(r => {
                const colaborador = colaboradoresLista.find(c => c.id === r.colaboradorTitularId);
                if (!colaborador) return false;
                
                let empresaOk = empresaSelecionada === 'todas' || colaborador.empresa === empresaSelecionada;
                let cidadeOk = cidadeSelecionada === 'todas' || colaborador.cidade === cidadeSelecionada;
                
                return empresaOk && cidadeOk;
            });

            const pendentes = colaboradoresFiltrados.length - retiradasFiltradas.length;
            const percentual = colaboradoresFiltrados.length > 0 
                ? ((retiradasFiltradas.length / colaboradoresFiltrados.length) * 100).toFixed(1) 
                : 0;

            document.getElementById('totalColaboradores').textContent = colaboradoresFiltrados.length;
            document.getElementById('pendentes').textContent = pendentes;
            document.getElementById('percentualRetirado').textContent = percentual + '%';
            document.getElementById('cidadeAtual').textContent = cidadeSelecionada === 'todas' ? 'Todas' : cidadeSelecionada;

            carregarGraficos(colaboradoresFiltrados, retiradasFiltradas);
            atualizarDistribuicaoCidade();

            const ultimasRetiradas = retiradasFiltradas.slice(-5).reverse();
            const container = document.getElementById('ultimasRetiradas');
            
            if (ultimasRetiradas.length > 0) {
                container.innerHTML = ultimasRetiradas.map(retirada => {
                    const colaborador = colaboradoresLista.find(c => c.id === r.colaboradorTitularId);
                    return `
                        <div class="list-item" style="display: flex; align-items: center; padding: 16px; background: var(--wsnet-bg-card); border-radius: var(--radius-md); margin-bottom: 10px; border: 1px solid var(--wsnet-border);" onclick="verDetalhesRetirada('${retirada.id}')">
                            <div style="width: 40px; height: 40px; background: var(--wsnet-bg-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; color: var(--wsnet-primary);">
                                <span class="material-icons">${retirada.quemRetirouTipo === 'Colaborador' ? 'person' : 'family_restroom'}</span>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500; color: var(--wsnet-text-dark); margin-bottom: 4px;">${retirada.colaboradorTitularNome}</div>
                                <div style="font-size: 13px; color: var(--wsnet-text-medium);">
                                    ${colaborador ? `<span style="background: rgba(102, 204, 255, 0.1); color: var(--wsnet-accent); padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 8px;">${colaborador.empresa}</span>` : ''}
                                    ${colaborador ? `<span style="background: rgba(255, 153, 0, 0.1); color: var(--wsnet-warning); padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 8px;">${colaborador.cidade}</span>` : ''}
                                    Retirado por: ${retirada.quemRetirouNome} • 
                                    ${new Date(retirada.dataRetirada).toLocaleDateString('pt-BR')} ${new Date(retirada.dataRetirada).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}
                                </div>
                            </div>
                            <span class="badge-success" style="padding: 4px 12px; border-radius: 12px; font-size: 12px;">Concluída</span>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <span class="material-icons" style="font-size: 48px; color: var(--wsnet-border); opacity: 0.5;">shopping_basket</span>
                        <p style="color: var(--wsnet-text-light); margin-top: 16px;">
                            Nenhuma retirada registrada ainda.
                        </p>
                    </div>
                `;
            }
        }

        function atualizarDistribuicaoCidade() {
            const container = document.getElementById('distribuicaoCidade');
            const cidades = ['Itanhaém', 'Mongaguá', 'Peruíbe'];
            
            let distribuiçãoHTML = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">';
            
            cidades.forEach(cidade => {
                const totalColaboradores = colaboradoresLista.filter(c => c.cidade === cidade && c.status !== 'inativo').length;
                const retiradasCidade = retiradasLista.filter(r => {
                    const colaborador = colaboradoresLista.find(c => c.id === r.colaboradorTitularId);
                    return colaborador && colaborador.cidade === cidade && colaborador.status !== 'inativo';
                }).length;
                const pendentesCidade = totalColaboradores - retiradasCidade;
                const percentualCidade = totalColaboradores > 0 ? ((retiradasCidade / totalColaboradores) * 100).toFixed(1) : 0;
                
                distribuiçãoHTML += `
                    <div style="background: var(--wsnet-bg-light); padding: 20px; border-radius: var(--radius-md); text-align: center;">
                        <div style="font-size: 14px; font-weight: 500; color: var(--wsnet-primary-dark); margin-bottom: 8px;">${cidade}</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--wsnet-primary); margin-bottom: 4px;">${totalColaboradores}</div>
                        <div style="font-size: 12px; color: var(--wsnet-text-medium);">Total Colaboradores</div>
                        <div style="display: flex; justify-content: space-between; margin-top: 12px;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--wsnet-success);">${retiradasCidade}</div>
                                <div style="font-size: 11px; color: var(--wsnet-text-medium);">Retirados</div>
                            </div>
                            <div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--wsnet-warning);">${pendentesCidade}</div>
                                <div style="font-size: 11px; color: var(--wsnet-text-medium);">Pendentes</div>
                            </div>
                            <div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--wsnet-info);">${percentualCidade}%</div>
                                <div style="font-size: 11px; color: var(--wsnet-text-medium);">Taxa</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            distribuiçãoHTML += '</div>';
            container.innerHTML = distribuiçãoHTML;
        }

        function carregarGraficos(colaboradoresFiltrados, retiradasFiltradas) {
            const retirados = retiradasFiltradas.length;
            const pendentes = colaboradoresFiltrados.length - retirados;

            const ctx = document.getElementById('chartStatus').getContext('2d');
            if (charts.status) charts.status.destroy();
            
            charts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Retirados', 'Pendentes'],
                    datasets: [{
                        data: [retirados, pendentes],
                        backgroundColor: ['#00CC66', '#FF9900'],
                        borderColor: ['#00CC66', '#FF9900'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // ==================== RETIRADA ====================
        function carregarRetirada() {
            const empresaSelecionada = document.getElementById('filtroEmpresaRetirada').value;
            const cidadeSelecionada = document.getElementById('filtroCidadeRetirada').value;
            const colaboradoresFiltrados = filtrarPorEmpresaECidade(colaboradoresLista, empresaSelecionada, cidadeSelecionada);
            
            const retiradosIds = retiradasLista.map(r => r.colaboradorTitularId);
            const pendentes = colaboradoresFiltrados.filter(c => !retiradosIds.includes(c.id));

            const container = document.getElementById('listaRetirada');
            
            if (pendentes.length > 0) {
                container.innerHTML = pendentes.map(colaborador => `
                    <div class="list-item" style="display: flex; align-items: center; padding: 16px; background: var(--wsnet-bg-card); border-radius: var(--radius-md); margin-bottom: 10px; border: 1px solid var(--wsnet-border); cursor: pointer;" onclick="abrirModalRetirada('${colaborador.id}')">
                        <div style="width: 40px; height: 40px; background: var(--wsnet-bg-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; color: var(--wsnet-primary);">
                            <span class="material-icons">person</span>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: var(--wsnet-text-dark); margin-bottom: 4px;">${colaborador.nome}</div>
                            <div style="font-size: 13px; color: var(--wsnet-text-medium);">
                                ${colaborador.empresa ? `<span style="background: rgba(102, 204, 255, 0.1); color: var(--wsnet-accent); padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 8px;">${colaborador.empresa}</span>` : ''}
                                ${colaborador.cidade ? `<span style="background: rgba(255, 153, 0, 0.1); color: var(--wsnet-warning); padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 8px;">${colaborador.cidade}</span>` : ''}
                                ${colaborador.departamento ? `<span style="background: rgba(0, 204, 102, 0.1); color: var(--wsnet-success); padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 8px;">${colaborador.departamento}</span>` : ''}
                                ${colaborador.dependentes?.length || 0} dependente(s)
                            </div>
                        </div>
                        <span class="badge-warning" style="padding: 4px 12px; border-radius: 12px; font-size: 12px;">Pendente</span>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <span class="material-icons" style="font-size: 48px; color: var(--wsnet-success);">check_circle</span>
                        <h3 style="margin: 20px 0 10px 0; color: var(--wsnet-text-dark);">Todas as cestas foram retiradas!</h3>
                        <p style="color: var(--wsnet-text-medium);">Nenhum colaborador pendente para este mês.</p>
                    </div>
                `;
            }
        }

        function filtrarColaboradoresRetirada() {
            const search = document.getElementById('searchRetirada').value.toLowerCase();
            const items = document.querySelectorAll('#listaRetirada .list-item');
            
            items.forEach(item => {
                const title = item.querySelector('div > div:first-child').textContent.toLowerCase();
                const subtitle = item.querySelector('div > div:nth-child(2)').textContent.toLowerCase();
                
                if (title.includes(search) || subtitle.includes(search)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function abrirModalRetirada(colaboradorId) {
            const colaborador = colaboradoresLista.find(c => c.id === colaboradorId);
            if (!colaborador) return;

            colaboradorSelecionado = colaborador;
            document.getElementById('titularRetirada').textContent = colaborador.nome;

            const autorizados = [
                {
                    id: colaborador.id,
                    nome: colaborador.nome,
                    tipo: 'Colaborador'
                },
                ...(colaborador.dependentes || []).map(dep => ({
                    id: dep.id,
                    nome: dep.nome,
                    tipo: 'Dependente',
                    parentesco: dep.parentesco
                }))
            ];

            const container = document.getElementById('listaAutorizados');
            container.innerHTML = autorizados.map(autorizado => `
                <div class="list-item" style="display: flex; align-items: center; padding: 16px; background: var(--wsnet-bg-card); border-radius: var(--radius-md); margin-bottom: 10px; border: 1px solid var(--wsnet-border); cursor: pointer;" onclick="solicitarConfirmacaoRetirada('${autorizado.id}', '${autorizado.nome}', '${autorizado.tipo}', '${autorizado.parentesco || ''}')">
                    <div style="width: 40px; height: 40px; background: var(--wsnet-bg-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; color: var(--wsnet-primary);">
                        <span class="material-icons">${autorizado.tipo === 'Colaborador' ? 'person' : 'family_restroom'}</span>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: var(--wsnet-text-dark); margin-bottom: 4px;">${autorizado.nome}</div>
                        <div style="font-size: 13px; color: var(--wsnet-text-medium);">
                            ${autorizado.tipo === 'Colaborador' ? 'Titular' : `Dependente - ${autorizado.parentesco}`}
                        </div>
                    </div>
                    <span class="material-icons" style="color: var(--wsnet-text-light);">chevron_right</span>
                </div>
            `).join('');

            openModal('modalRetirada');
        }

        function solicitarConfirmacaoRetirada(quemRetirouId, quemRetirouNome, quemRetirouTipo, parentesco) {
            retiradaPendente = {
                quemRetirouId,
                quemRetirouNome,
                quemRetirouTipo,
                parentesco
            };

            const mensagem = `Deseja confirmar a retirada de cesta de <strong>"${colaboradorSelecionado.nome}"</strong> por <strong>"${quemRetirouNome}"</strong>?`;
            
            document.getElementById('confirmacaoMensagem').innerHTML = mensagem;
            document.getElementById('confirmacaoTitulo').textContent = 'Confirmar Retirada';
            
            closeModal('modalRetirada');
            openModal('confirmacaoRetirada');
        }

        function cancelarConfirmacao() {
            closeModal('confirmacaoRetirada');
            retiradaPendente = null;
        }

        async function confirmarRetirada() {
            if (!retiradaPendente || !colaboradorSelecionado) return;

            const { quemRetirouId, quemRetirouNome, quemRetirouTipo } = retiradaPendente;
            
            const retirada = {
                colaboradorTitularId: colaboradorSelecionado.id,
                colaboradorTitularNome: colaboradorSelecionado.nome,
                quemRetirouId: quemRetirouId,
                quemRetirouNome: quemRetirouNome,
                quemRetirouTipo: quemRetirouTipo,
                dataRetirada: new Date().toISOString(),
                mesReferencia: mesAtual,
                confirmadoPor: currentUser?.nome || currentUser?.email || 'Registrador',
                createdBy: currentUser?.email || 'Registrador'
            };

            const sucesso = await registrarRetiradaFirebase(retirada);
            
            if (sucesso) {
                showAlert(`Retirada registrada para ${colaboradorSelecionado.nome}! Retirante: ${quemRetirouNome}`);
                ultimaRetiradaRegistrada = retirada;
            } else {
                showAlert('Erro ao registrar retirada. Tente novamente.', 'error');
            }
            
            closeModal('confirmacaoRetirada');
            retiradaPendente = null;
        }

        // ==================== COLABORADORES ====================
        function carregarColaboradores() {
            const colaboradoresFiltrados = obterColaboradoresFiltrados();
            renderizarListaColaboradores(colaboradoresFiltrados);
            atualizarContadorColaboradores();
        }

        function renderizarListaColaboradores(colaboradores) {
            const container = document.getElementById('listaColaboradores');
            
            if (colaboradores.length > 0) {
                const itemsHTML = colaboradores.map(colaborador => `
                    <div style="display: flex; align-items: center; padding: 16px; border-bottom: 1px solid var(--wsnet-border);">
                        <div style="flex: 2; display: flex; align-items: center;">
                            <div style="width: 40px; height: 40px; background: ${colaborador.status === 'ativo' ? 'var(--wsnet-bg-light)' : 'rgba(255, 51, 51, 0.1)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; color: ${colaborador.status === 'ativo' ? 'var(--wsnet-primary)' : 'var(--wsnet-danger)'};">
                                <span class="material-icons">person</span>
                            </div>
                            <div>
                                <div style="font-weight: 500; color: var(--wsnet-text-dark); margin-bottom: 4px;">${colaborador.nome}</div>
                                <div style="font-size: 12px; color: var(--wsnet-text-light);">
                                    ${colaborador.createdAt ? `Criado: ${new Date(colaborador.createdAt).toLocaleDateString('pt-BR')}` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            ${colaborador.empresa ? `<span style="background: rgba(102, 204, 255, 0.1); color: var(--wsnet-accent); padding: 4px 8px; border-radius: 8px; font-size: 12px;">${colaborador.empresa}</span>` : 'Não informado'}
                        </div>
                        <div style="flex: 1;">
                            ${colaborador.cidade ? `<span style="background: rgba(255, 153, 0, 0.1); color: var(--wsnet-warning); padding: 4px 8px; border-radius: 8px; font-size: 12px;">${colaborador.cidade}</span>` : 'Não informado'}
                        </div>
                        <div style="flex: 1;">
                            ${colaborador.departamento ? `<span style="background: rgba(0, 204, 102, 0.1); color: var(--wsnet-success); padding: 4px 8px; border-radius: 8px; font-size: 12px;">${colaborador.departamento}</span>` : 'Não informado'}
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <span style="background: ${colaborador.dependentes?.length > 0 ? 'rgba(0, 153, 204, 0.1)' : 'rgba(102, 102, 102, 0.1)'}; color: ${colaborador.dependentes?.length > 0 ? 'var(--wsnet-info)' : 'var(--wsnet-text-light)'}; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                                ${colaborador.dependentes?.length || 0}
                            </span>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <span style="background: ${colaborador.status === 'ativo' ? 'rgba(0, 204, 102, 0.1)' : 'rgba(255, 51, 51, 0.1)'}; 
                                     color: ${colaborador.status === 'ativo' ? 'var(--wsnet-success)' : 'var(--wsnet-danger)'}; 
                                     padding: 4px 12px; border-radius: 12px; font-size: 12px; cursor: pointer;"
                                  onclick="toggleStatusColaborador('${colaborador.id}', '${colaborador.status === 'ativo' ? 'inativo' : 'ativo'}')"
                                  title="Clique para ${colaborador.status === 'ativo' ? 'inativar' : 'ativar'}">
                                ${colaborador.status === 'ativo' ? 'Ativo' : 'Inativo'}
                            </span>
                        </div>
                        <div style="flex: 1; display: flex; gap: 8px; justify-content: center;">
                            <button style="width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(0, 102, 204, 0.1); color: var(--wsnet-primary); display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="editarColaborador('${colaborador.id}')" title="Editar">
                                <span class="material-icons">edit</span>
                            </button>
                            <button style="width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(255, 51, 51, 0.1); color: var(--wsnet-danger); display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="excluirColaborador('${colaborador.id}')" title="Excluir">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = itemsHTML;
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <span class="material-icons" style="font-size: 48px; color: var(--wsnet-border); opacity: 0.5;">group</span>
                        <h3 style="margin: 20px 0 10px 0; color: var(--wsnet-text-dark);">Nenhum colaborador encontrado</h3>
                        <p style="color: var(--wsnet-text-medium);">${document.getElementById('filtroEmpresaColaboradores').value !== 'todas' || document.getElementById('filtroCidadeColaboradores').value !== 'todas' || document.getElementById('filtroStatusColaboradores').value !== 'ativo' ? 'Tente mudar os filtros de empresa, cidade ou status.' : 'Clique em "Novo Colaborador" para começar.'}</p>
                    </div>
                `;
            }
        }

        function filtrarColaboradores() {
            const colaboradoresFiltrados = obterColaboradoresFiltrados();
            renderizarListaColaboradores(colaboradoresFiltrados);
            atualizarContadorColaboradores();
        }

        function openCadastroColaborador() {
            document.getElementById('formColaborador').reset();
            document.getElementById('modalColaboradorTitulo').textContent = 'Cadastrar Colaborador';
            document.getElementById('btnSalvarColaborador').innerHTML = '<span class="material-icons">save</span> Salvar';
            document.getElementById('colaboradorId').value = '';
            
            const db = new LocalDatabase();
            const departamentos = db.getDepartamentos();
            
            const deptoSelect = document.getElementById('departamentoColaborador');
            let options = '<option value="">Selecione o departamento...</option>';
            departamentos.forEach(depto => {
                options += `<option value="${depto}">${depto}</option>`;
            });
            deptoSelect.innerHTML = options;
            
            carregarEmpresasSelect();
            
            dependentesEditando = [];
            modoEdicao = false;
            atualizarListaDependentes();
            mostrarAbaDependentes('lista');
            
            openModal('modalColaborador');
        }

        function editarColaborador(colaboradorId) {
            const colaborador = colaboradoresLista.find(c => c.id === colaboradorId);
            if (!colaborador) return;

            document.getElementById('modalColaboradorTitulo').textContent = 'Editar Colaborador';
            document.getElementById('btnSalvarColaborador').innerHTML = '<span class="material-icons">save</span> Atualizar';
            document.getElementById('colaboradorId').value = colaborador.id;
            document.getElementById('nomeColaborador').value = colaborador.nome || '';
            
            const db = new LocalDatabase();
            const departamentos = db.getDepartamentos();
            
            const deptoSelect = document.getElementById('departamentoColaborador');
            let options = '<option value="">Selecione o departamento...</option>';
            departamentos.forEach(depto => {
                options += `<option value="${depto}">${depto}</option>`;
            });
            deptoSelect.innerHTML = options;
            document.getElementById('departamentoColaborador').value = colaborador.departamento || '';
            
            carregarEmpresasSelect();
            document.getElementById('empresaColaborador').value = colaborador.empresa || '';
            document.getElementById('cidadeColaborador').value = colaborador.cidade || '';
            document.getElementById('statusColaborador').value = colaborador.status || 'ativo';
            
            dependentesEditando = [...(colaborador.dependentes || [])];
            modoEdicao = true;
            
            atualizarListaDependentes();
            mostrarAbaDependentes('lista');
            openModal('modalColaborador');
        }

        function excluirColaborador(colaboradorId) {
            excluirColaboradorFirebase(colaboradorId);
        }

        function carregarEmpresasSelect() {
            const select = document.getElementById('empresaColaborador');
            
            let options = '<option value="">Selecione a empresa...</option>';
            empresasLista.forEach(empresa => {
                options += `<option value="${empresa}">${empresa}</option>`;
            });
            
            select.innerHTML = options;
        }

        function mostrarAbaDependentes(aba) {
            document.querySelectorAll('#abaListaDependentes, #abaAdicionarDependente').forEach(el => {
                el.style.display = 'none';
            });
            
            if (aba === 'lista') {
                document.getElementById('abaListaDependentes').style.display = 'block';
                document.querySelectorAll('.btn-outline').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.btn-outline')[0].classList.add('active');
            } else {
                document.getElementById('abaAdicionarDependente').style.display = 'block';
                document.querySelectorAll('.btn-outline').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.btn-outline')[1].classList.add('active');
            }
        }

        function atualizarListaDependentes() {
            const container = document.getElementById('listaDependentesCadastrados');
            const contador = document.getElementById('contadorDependentes');
            
            contador.textContent = dependentesEditando.length;
            
            if (dependentesEditando.length > 0) {
                container.innerHTML = dependentesEditando.map((dep, index) => `
                    <div style="display: flex; align-items: center; padding: 12px; background: var(--wsnet-bg-card); border-radius: var(--radius-md); margin-bottom: 8px; border: 1px solid var(--wsnet-border);">
                        <div style="width: 32px; height: 32px; background: var(--wsnet-bg-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; color: var(--wsnet-primary);">
                            <span class="material-icons">person</span>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: var(--wsnet-text-dark); margin-bottom: 2px;">${dep.nome}</div>
                            <div style="font-size: 12px; color: var(--wsnet-text-medium);">${dep.parentesco}</div>
                        </div>
                        <button style="width: 32px; height: 32px; border-radius: 50%; border: none; background: rgba(255, 51, 51, 0.1); color: var(--wsnet-danger); display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="removerDependente(${index})" title="Remover">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <p style="color: var(--wsnet-text-light); text-align: center; padding: 20px; background: var(--wsnet-bg-light); border-radius: var(--radius-md);">
                        Nenhum dependente cadastrado
                    </p>
                `;
            }
        }

        function adicionarNovoDependente() {
            const nome = document.getElementById('novoDependenteNome').value.trim();
            const parentesco = document.getElementById('novoDependenteParentesco').value;
            
            if (!nome) {
                showAlert('Digite o nome do dependente!', 'error');
                return;
            }
            
            if (!parentesco) {
                showAlert('Selecione o parentesco!', 'error');
                return;
            }
            
            if (dependentesEditando.length >= 3) {
                showAlert('Máximo de 3 dependentes atingido!', 'error');
                return;
            }
            
            const novoDependente = {
                id: Date.now().toString() + Math.random(),
                nome: nome,
                parentesco: parentesco,
                autorizado: true
            };
            
            dependentesEditando.push(novoDependente);
            
            document.getElementById('novoDependenteNome').value = '';
            document.getElementById('novoDependenteParentesco').value = '';
            
            atualizarListaDependentes();
            mostrarAbaDependentes('lista');
            
            showAlert('Dependente adicionado com sucesso!');
        }

        function removerDependente(index) {
            if (!confirm('Remover este dependente?')) {
                return;
            }
            
            dependentesEditando.splice(index, 1);
            atualizarListaDependentes();
            showAlert('Dependente removido!');
        }

        // ==================== GERENCIAR DEPARTAMENTOS ====================
        function openGerenciarDepartamentos() {
            carregarListaDepartamentos();
            openModal('modalDepartamentos');
        }

        function carregarListaDepartamentos() {
            const db = new LocalDatabase();
            const departamentos = db.getDepartamentos();
            const container = document.getElementById('listaDepartamentos');
            
            if (departamentos.length > 0) {
                container.innerHTML = departamentos.map(depto => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--wsnet-bg-light); border-radius: var(--radius-md); border: 1px solid var(--wsnet-border);">
                        <span style="color: var(--wsnet-text-dark);">${depto}</span>
                        <button style="padding: 4px 8px; font-size: 12px; background: var(--wsnet-danger); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer;" onclick="removerDepartamento('${depto}')">
                            <span class="material-icons" style="font-size: 16px;">delete</span>
                        </button>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <p style="color: var(--wsnet-text-light); text-align: center; padding: 20px;">
                        Nenhum departamento cadastrado.
                    </p>
                `;
            }
        }

        function adicionarDepartamento() {
            const input = document.getElementById('novoDepartamento');
            const novoDepartamento = input.value.trim();
            
            if (!novoDepartamento) {
                showAlert('Digite o nome do departamento!', 'error');
                return;
            }

            const db = new LocalDatabase();
            if (db.adicionarDepartamento(novoDepartamento)) {
                showAlert(`Departamento "${novoDepartamento}" adicionado com sucesso!`);
                input.value = '';
                carregarListaDepartamentos();
                atualizarDepartamentosEmTodosLocais();
            } else {
                showAlert('Este departamento já existe!', 'error');
            }
        }

        function removerDepartamento(departamento) {
            if (!confirm(`Tem certeza que deseja remover o departamento "${departamento}"?\n\nEsta ação não afetará os colaboradores já cadastrados, mas novos colaboradores não poderão selecionar este departamento.`)) {
                return;
            }

            const db = new LocalDatabase();
            if (db.removerDepartamento(departamento)) {
                showAlert(`Departamento "${departamento}" removido com sucesso!`);
                carregarListaDepartamentos();
                atualizarDepartamentosEmTodosLocais();
            }
        }

        function atualizarDepartamentosEmTodosLocais() {
            const db = new LocalDatabase();
            const departamentos = db.getDepartamentos();
            
            if (document.getElementById('modalColaborador').style.display === 'block') {
                const deptoSelect = document.getElementById('departamentoColaborador');
                let options = '<option value="">Selecione o departamento...</option>';
                departamentos.forEach(depto => {
                    options += `<option value="${depto}">${depto}</option>`;
                });
                deptoSelect.innerHTML = options;
            }
        }

        // ==================== GERENCIAR EMPRESAS ====================
        function openGerenciarEmpresas() {
            carregarListaEmpresas();
            openModal('modalEmpresas');
        }

        function carregarListaEmpresas() {
            const container = document.getElementById('listaEmpresas');
            
            if (empresasLista.length > 0) {
                container.innerHTML = empresasLista.map(empresa => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--wsnet-bg-light); border-radius: var(--radius-md); border: 1px solid var(--wsnet-border);">
                        <span style="color: var(--wsnet-text-dark);">${empresa}</span>
                        <button style="padding: 4px 8px; font-size: 12px; background: var(--wsnet-danger); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer;" onclick="removerEmpresaFirebase('${empresa}')">
                            <span class="material-icons" style="font-size: 16px;">delete</span>
                        </button>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <p style="color: var(--wsnet-text-light); text-align: center; padding: 20px;">
                        Nenhuma empresa cadastrada.
                    </p>
                `;
            }
        }

        // ==================== NOVO MÊS ====================
        function abrirModalNovoMes() {
            const [anoAtual, mesAtualNum] = mesAtual.split('-').map(Number);
            
            const meses = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            
            document.getElementById('mesAtualLabel').textContent = `${meses[mesAtualNum - 1]} de ${anoAtual}`;
            
            let proximoAno = anoAtual;
            let proximoMes = mesAtualNum + 1;
            
            if (proximoMes > 12) {
                proximoMes = 1;
                proximoAno++;
            }
            
            document.getElementById('novoMesSelecionado').value = String(proximoMes).padStart(2, '0');
            document.getElementById('novoAnoSelecionado').value = proximoAno;
            
            openModal('modalNovoMes');
        }

        async function confirmarNovoMes() {
            const novoMes = document.getElementById('novoMesSelecionado').value;
            const novoAno = document.getElementById('novoAnoSelecionado').value;
            
            if (!novoMes || !novoAno) {
                showAlert('Selecione o mês e ano para iniciar!', 'error');
                return;
            }
            
            const novoMesCompleto = `${novoAno}-${novoMes}`;
            
            const db = new LocalDatabase();
            
            // Salvar histórico das retiradas do mês anterior
            if (retiradasLista.length > 0) {
                const historico = JSON.parse(localStorage.getItem('historicoRetiradas') || '[]');
                const [anoAntigo, mesAntigo] = mesAtual.split('-');
                const meses = [
                    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                
                historico.push({
                    mes: mesAtual,
                    mesDescricao: `${meses[parseInt(mesAntigo) - 1]} de ${anoAntigo}`,
                    totalRetiradas: retiradasLista.length,
                    totalColaboradores: colaboradoresLista.filter(c => c.status !== 'inativo').length,
                    percentual: colaboradoresLista.filter(c => c.status !== 'inativo').length > 0 ? 
                        ((retiradasLista.length / colaboradoresLista.filter(c => c.status !== 'inativo').length) * 100).toFixed(1) : 0,
                    dataEncerramento: new Date().toISOString(),
                    realizadoPor: currentUser?.email || 'Sistema',
                    observacao: 'Mês encerrado - Todos os colaboradores ficaram como PENDENTES para o novo mês'
                });
                
                localStorage.setItem('historicoRetiradas', JSON.stringify(historico));
            }
            
            // Atualizar o mês atual no localStorage
            db.setMesAtual(novoMesCompleto);
            
            // Limpar a lista local de retiradas
            retiradasLista = [];
            
            // Limpar retiradas do Firebase
            try {
                await limparTodasRetiradasFirebase();
            } catch (error) {
                console.error('Erro ao limpar retiradas do Firebase:', error);
            }
            
            const meses = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            const mesFormatado = meses[parseInt(novoMes) - 1];
            
            showAlert(`Novo mês iniciado: ${mesFormatado} de ${novoAno}! Todos os colaboradores estão como PENDENTES para o novo mês.`, 'success');
            
            closeModal('modalNovoMes');
            
            // Atualizar todas as telas
            carregarDashboard();
            carregarRetirada();
            carregarMesAnoAtual();
        }

        // ==================== LIMPAR RETIRADAS ====================
        function abrirModalLimparRetiradas() {
            document.getElementById('confirmacaoLimpar').value = '';
            document.getElementById('btnConfirmarLimpeza').disabled = true;
            
            document.getElementById('confirmacaoLimpar').addEventListener('input', function() {
                const btn = document.getElementById('btnConfirmarLimpeza');
                btn.disabled = this.value.toUpperCase() !== 'LIMPAR';
            });
            
            openModal('modalLimparRetiradas');
        }

        async function confirmarLimpezaRetiradas() {
            const confirmacao = document.getElementById('confirmacaoLimpar').value;
            
            if (confirmacao.toUpperCase() !== 'LIMPAR') {
                showAlert('Digite "LIMPAR" para confirmar a ação!', 'error');
                return;
            }
            
            const sucesso = await limparTodasRetiradasFirebase();
            if (sucesso) {
                showAlert('Todas as retiradas foram limpas com sucesso!', 'success');
                retiradasLista = [];
                
                // Salvar no histórico local
                const historico = JSON.parse(localStorage.getItem('historicoRetiradas') || '[]');
                historico.push({
                    data: new Date().toISOString(),
                    acao: 'Limpeza completa de retiradas',
                    realizadoPor: currentUser?.email || 'Sistema',
                    observacao: 'Todas as retiradas foram apagadas. Colaboradores ficaram como PENDENTES.'
                });
                localStorage.setItem('historicoRetiradas', JSON.stringify(historico));
                
                // Atualizar a interface
                carregarDashboard();
                carregarRetirada();
            } else {
                showAlert('Erro ao limpar as retiradas!', 'error');
            }
            
            closeModal('modalLimparRetiradas');
        }

        // ==================== RELATÓRIOS ====================
        function carregarMesAnoAtual() {
            const [ano, mes] = mesAtual.split('-').map(Number);
            document.getElementById('mesRelatorio').value = String(mes).padStart(2, '0');
            document.getElementById('anoRelatorio').value = ano;
        }

        async function carregarRelatorioManual() {
            try {
                const mesSelecionado = document.getElementById('mesRelatorio').value;
                const anoSelecionado = document.getElementById('anoRelatorio').value;
                const empresaSelecionada = document.getElementById('empresaRelatorio').value;
                const cidadeSelecionada = document.getElementById('cidadeRelatorio').value;
                const tipoLista = document.getElementById('tipoListaRelatorio').value;
                
                if (!mesSelecionado || !anoSelecionado) {
                    showAlert('Selecione o mês e ano para visualizar o relatório!', 'error');
                    return;
                }
                
                await carregarRelatorio(null, empresaSelecionada, cidadeSelecionada, tipoLista);
            } catch (erro) {
                console.error("Erro ao carregar relatório manual:", erro);
                showAlert('Erro ao carregar relatório. Verifique os filtros e tente novamente.', 'error');
            }
        }

        // ==================== FUNÇÕES AUXILIARES RELATÓRIOS ====================
        async function carregarRetiradasPorMes(mesReferencia) {
            try {
                const db = window.firebaseDb;
                const { collection, getDocs, query, where } = window.firebaseCollections;
                
                const retiradasRef = collection(db, "retiradas");
                const q = query(retiradasRef, where("mesReferencia", "==", mesReferencia));
                const querySnapshot = await getDocs(q);
                
                const retiradas = [];
                querySnapshot.forEach((doc) => {
                    retiradas.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                return retiradas;
            } catch (erro) {
                console.error("Erro ao carregar retiradas do mês:", erro);
                return [];
            }
        }

        async function carregarRelatorio(mesParam = null, empresaParam = null, cidadeParam = null, tipoListaParam = null) {
            try {
                const mesSelecionado = mesParam || `${document.getElementById('anoRelatorio').value}-${document.getElementById('mesRelatorio').value}`;
                const empresaSelecionada = empresaParam || document.getElementById('empresaRelatorio').value;
                const cidadeSelecionada = cidadeParam || document.getElementById('cidadeRelatorio').value;
                const tipoLista = tipoListaParam || document.getElementById('tipoListaRelatorio').value;
                
                if (!mesSelecionado || mesSelecionado === 'undefined-undefined') {
                    showAlert('Selecione um mês e ano válidos!', 'error');
                    return;
                }
                
                // Garantir que temos a lista de colaboradores
                if (!colaboradoresLista || colaboradoresLista.length === 0) {
                    await carregarColaboradoresDoFirebase();
                }
                
                // Carregar retiradas do mês selecionado
                const retiradasMes = await carregarRetiradasPorMes(mesSelecionado);
                
                // Filtrar colaboradores (apenas ativos para relatórios)
                let colaboradoresFiltrados = [...colaboradoresLista.filter(c => c.status !== 'inativo')];
                if (empresaSelecionada !== 'todas') {
                    colaboradoresFiltrados = colaboradoresFiltrados.filter(c => c.empresa === empresaSelecionada);
                }
                if (cidadeSelecionada !== 'todas') {
                    colaboradoresFiltrados = colaboradoresFiltrados.filter(c => c.cidade === cidadeSelecionada);
                }
                
                // Filtrar retiradas pelos mesmos filtros de empresa e cidade
                let retiradasFiltradas = retiradasMes.filter(r => {
                    const colaborador = colaboradoresLista.find(c => c.id === r.colaboradorTitularId);
                    if (!colaborador) return false;
                    
                    let empresaOk = empresaSelecionada === 'todas' || colaborador.empresa === empresaSelecionada;
                    let cidadeOk = cidadeSelecionada === 'todas' || colaborador.cidade === cidadeSelecionada;
                    
                    return empresaOk && cidadeOk;
                });
                
                // Cálculos
                const totalColaboradores = colaboradoresFiltrados.length;
                const totalRetiradas = retiradasFiltradas.length;
                const percentual = totalColaboradores > 0 
                    ? ((totalRetiradas / totalColaboradores) * 100).toFixed(1)
                    : 0;
                
                const retiradosIds = [...new Set(retiradasFiltradas.map(r => r.colaboradorTitularId))];
                const naoRetiraram = colaboradoresFiltrados.filter(c => !retiradosIds.includes(c.id));
                const jaRetiraram = colaboradoresFiltrados.filter(c => retiradosIds.includes(c.id));
                
                // Ordenar
                jaRetiraram.sort((a, b) => a.nome.localeCompare(b.nome));
                naoRetiraram.sort((a, b) => a.nome.localeCompare(b.nome));
                
                // Formatar mês para exibição
                const meses = [
                    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                const [ano, mesNum] = mesSelecionado.split('-').map(Number);
                const mesFormatado = `${meses[mesNum - 1]} de ${ano}`;
                
                // Atualizar estatísticas
                document.getElementById('relatorioTotalColaboradores').textContent = totalColaboradores;
                document.getElementById('relatorioTotalRetiradas').textContent = totalRetiradas;
                document.getElementById('relatorioPercentual').textContent = percentual + '%';
                document.getElementById('relatorioCidade').textContent = cidadeSelecionada === 'todas' ? 'Todas' : cidadeSelecionada;
                
                // Mostrar/ocultar seções baseado no filtro de tipo de lista
                const cardRetirados = document.getElementById('cardRetirados');
                const cardNaoRetiraram = document.getElementById('cardNaoRetiraram');
                
                if (tipoLista === 'ambas') {
                    cardRetirados.style.display = 'block';
                    cardNaoRetiraram.style.display = 'block';
                } else if (tipoLista === 'retirados') {
                    cardRetirados.style.display = 'block';
                    cardNaoRetiraram.style.display = 'none';
                } else if (tipoLista === 'nao_retirados') {
                    cardRetirados.style.display = 'none';
                    cardNaoRetiraram.style.display = 'block';
                }
                
                // Atualizar listas apenas se a seção estiver visível
                if (tipoLista === 'ambas' || tipoLista === 'retirados') {
                    atualizarListaRetirados(jaRetiraram, retiradasFiltradas);
                }
                
                if (tipoLista === 'ambas' || tipoLista === 'nao_retirados') {
                    atualizarListaNaoRetiraram(naoRetiraram);
                }
                
                // Atualizar título
                const cardTitle = document.querySelector('#relatorios .card-title');
                if (cardTitle) {
                    let titulo = `Relatório - ${mesFormatado}`;
                    if (empresaSelecionada !== 'todas') titulo += ` - ${empresaSelecionada}`;
                    if (cidadeSelecionada !== 'todas') titulo += ` (${cidadeSelecionada})`;
                    cardTitle.innerHTML = `<span class="material-icons">assessment</span> ${titulo}`;
                }
                
            } catch (erro) {
                console.error("Erro ao carregar relatório:", erro);
                showAlert('Erro ao carregar dados do relatório. Verifique sua conexão e tente novamente.', 'error');
            }
        }

        function atualizarListaRetirados(jaRetiraram, retiradasFiltradas) {
            const containerRetirados = document.getElementById('listaRetirados');
            
            if (jaRetiraram.length > 0) {
                containerRetirados.innerHTML = jaRetiraram.map(colab => {
                    const retiradaDoColab = retiradasFiltradas.find(r => r.colaboradorTitularId === colab.id);
                    return `
                        <div style="padding: 12px 0; border-bottom: 1px solid var(--wsnet-border);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span class="material-icons" style="font-size: 16px; color: var(--wsnet-success); vertical-align: middle; margin-right: 8px;">check_circle</span>
                                    <strong>${colab.nome}</strong>
                                    ${colab.empresa ? `<span style="background: rgba(102, 204, 255, 0.1); color: var(--wsnet-accent); padding: 2px 8px; border-radius: 8px; font-size: 11px; margin-left: 8px;">${colab.empresa}</span>` : ''}
                                    ${colab.cidade ? `<span style="background: rgba(255, 153, 0, 0.1); color: var(--wsnet-warning); padding: 2px 8px; border-radius: 8px; font-size: 11px; margin-left: 8px;">${colab.cidade}</span>` : ''}
                                    ${colab.departamento ? `<span style="background: rgba(0, 204, 102, 0.1); color: var(--wsnet-success); padding: 2px 8px; border-radius: 8px; font-size: 11px; margin-left: 8px;">${colab.departamento}</span>` : ''}
                                </div>
                                ${retiradaDoColab ? `
                                    <div>
                                        <button style="padding: 4px 8px; font-size: 12px; background: transparent; border: 1px solid var(--wsnet-primary); color: var(--wsnet-primary); border-radius: var(--radius-sm); cursor: pointer; margin-right: 8px;" onclick="verDetalhesRetirada('${retiradaDoColab.id}')">
                                            Ver detalhes
                                        </button>
                                        <button style="padding: 4px 8px; font-size: 12px; background: rgba(255, 51, 51, 0.1); border: 1px solid var(--wsnet-danger); color: var(--wsnet-danger); border-radius: var(--radius-sm); cursor: pointer;" onclick="abrirModalCancelarRetirada('${retiradaDoColab.id}')">
                                            Cancelar
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            ${retiradaDoColab ? `
                                <div style="margin-left: 24px; font-size: 13px; color: var(--wsnet-text-medium); margin-top: 8px;">
                                    Retirado por: ${retiradaDoColab.quemRetirouNome} (${retiradaDoColab.quemRetirouTipo}) • 
                                    ${new Date(retiradaDoColab.dataRetirada).toLocaleDateString('pt-BR')} às ${new Date(retiradaDoColab.dataRetirada).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}
                                    <br>
                                    <small>Registrado por: ${retiradaDoColab.createdBy || currentUser?.email || 'Sistema'}</small>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } else {
                containerRetirados.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <span class="material-icons" style="font-size: 36px; color: var(--wsnet-border); opacity: 0.5;">info</span>
                        <p style="color: var(--wsnet-text-light); margin-top: 12px;">
                            Nenhum colaborador retirou neste mês.
                        </p>
                    </div>
                `;
            }
        }

        function atualizarListaNaoRetiraram(naoRetiraram) {
            const containerNaoRetiraram = document.getElementById('listaNaoRetiraram');
            
            if (naoRetiraram.length > 0) {
                containerNaoRetiraram.innerHTML = naoRetiraram.map(colab => `
                    <div style="padding: 12px 0; border-bottom: 1px solid var(--wsnet-border);">
                        <span class="material-icons" style="font-size: 16px; color: var(--wsnet-danger); vertical-align: middle; margin-right: 8px;">person</span>
                        ${colab.nome} 
                        ${colab.empresa ? `<span style="background: rgba(102, 204, 255, 0.1); color: var(--wsnet-accent); padding: 2px 8px; border-radius: 8px; font-size: 11px; margin-left: 8px;">${colab.empresa}</span>` : ''}
                        ${colab.cidade ? `<span style="background: rgba(255, 153, 0, 0.1); color: var(--wsnet-warning); padding: 2px 8px; border-radius: 8px; font-size: 11px; margin-left: 8px;">${colab.cidade}</span>` : ''}
                        ${colab.departamento ? `<span style="background: rgba(0, 204, 102, 0.1); color: var(--wsnet-success); padding: 2px 8px; border-radius: 8px; font-size: 11px; margin-left: 8px;">${colab.departamento}</span>` : ''}
                    </div>
                `).join('');
            } else {
                containerNaoRetiraram.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <span class="material-icons" style="font-size: 36px; color: var(--wsnet-border); opacity: 0.5;">info</span>
                        <p style="color: var(--wsnet-text-light); margin-top: 12px;">
                            Todos os colaboradores retiraram neste mês.
                        </p>
                    </div>
                `;
            }
        }

        // ==================== CANCELAR RETIRADA ====================
        function abrirModalCancelarRetirada(retiradaId) {
            retiradaParaCancelar = retiradaId;
            
            // Buscar a retirada específica
            const retirada = retiradasLista.find(r => r.id === retiradaId);
            const colaborador = retirada ? colaboradoresLista.find(c => c.id === r.colaboradorTitularId) : null;
            
            if (!retirada) {
                showAlert('Retirada não encontrada!', 'error');
                return;
            }
            
            const container = document.getElementById('listaRetiradasParaCancelar');
            container.innerHTML = `
                <div style="padding: 16px; background: var(--wsnet-bg-light); border-radius: var(--radius-md); margin-bottom: 16px;">
                    <h4 style="margin: 0 0 12px 0; color: var(--wsnet-primary-dark);">Detalhes da Retirada</h4>
                    <div style="margin-bottom: 8px;">
                        <strong>Colaborador:</strong> ${retirada.colaboradorTitularNome}
                    </div>
                    ${colaborador ? `
                        <div style="margin-bottom: 8px;">
                            <strong>Empresa:</strong> ${colaborador.empresa}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Cidade:</strong> ${colaborador.cidade}
                        </div>
                    ` : ''}
                    <div style="margin-bottom: 8px;">
                        <strong>Retirado por:</strong> ${retirada.quemRetirouNome} (${retirada.quemRetirouTipo})
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Data:</strong> ${new Date(retirada.dataRetirada).toLocaleDateString('pt-BR')} às ${new Date(retirada.dataRetirada).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Registrado por:</strong> ${retirada.createdBy || 'Sistema'}
                    </div>
                </div>
                <div class="alert alert-warning" style="display: block;">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 8px; color: var(--wsnet-warning);">warning</span>
                    <strong>Atenção:</strong> Ao cancelar esta retirada, o colaborador ficará como PENDENTE para este mês.
                </div>
            `;
            
            openModal('modalCancelarRetirada');
        }

        async function confirmarCancelamentoRetirada() {
            if (!retiradaParaCancelar) return;
            
            const motivo = document.getElementById('motivoCancelamento').value.trim();
            if (!motivo) {
                showAlert('Digite o motivo do cancelamento!', 'error');
                return;
            }
            
            const sucesso = await cancelarRetiradaFirebase(retiradaParaCancelar, motivo);
            if (sucesso) {
                showAlert('Retirada cancelada com sucesso! O colaborador agora está como PENDENTE.', 'success');
                closeModal('modalCancelarRetirada');
                
                // Atualizar a interface
                carregarDashboard();
                if (document.getElementById('retirada').classList.contains('active')) {
                    carregarRetirada();
                }
                if (document.getElementById('relatorios').classList.contains('active')) {
                    carregarRelatorioManual();
                }
            } else {
                showAlert('Erro ao cancelar retirada. Tente novamente.', 'error');
            }
            
            retiradaParaCancelar = null;
        }

        // ==================== DETALHES DA RETIRADA ====================
        function verDetalhesRetirada(retiradaId) {
            const retirada = retiradasLista.find(r => r.id === retiradaId);
            const colaborador = retirada ? colaboradoresLista.find(c => c.id === r.colaboradorTitularId) : null;
            
            if (!retirada) return;

            const detalhes = `
                <div style="padding: 10px 0;">
                    <div style="margin-bottom: 15px;">
                        <strong>Colaborador Titular:</strong><br>
                        ${retirada.colaboradorTitularNome}
                    </div>
                    ${colaborador ? `
                        <div style="margin-bottom: 15px;">
                            <strong>Empresa:</strong><br>
                            ${colaborador.empresa}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Cidade:</strong><br>
                            ${colaborador.cidade}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Departamento:</strong><br>
                            ${colaborador.departamento}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Status:</strong><br>
                            <span style="background: ${colaborador.status === 'ativo' ? 'rgba(0, 204, 102, 0.1)' : 'rgba(255, 51, 51, 0.1)'}; 
                                     color: ${colaborador.status === 'ativo' ? 'var(--wsnet-success)' : 'var(--wsnet-danger)'}; 
                                     padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                                ${colaborador.status === 'ativo' ? 'Ativo' : 'Inativo'}
                            </span>
                        </div>
                    ` : ''}
                    <div style="margin-bottom: 15px;">
                        <strong>Quem retirou:</strong><br>
                        ${retirada.quemRetirouNome} (${retirada.quemRetirouTipo})
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Data e Hora:</strong><br>
                        ${new Date(retirada.dataRetirada).toLocaleString('pt-BR')}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Mês de Referência:</strong><br>
                        ${retirada.mesReferencia}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Registrado por:</strong><br>
                        ${retirada.createdBy || currentUser?.email || 'Sistema'}
                    </div>
                    <div>
                        <strong>Confirmado por:</strong><br>
                        ${retirada.confirmadoPor}
                    </div>
                </div>
            `;

            document.getElementById('detalhesRetiradaConteudo').innerHTML = detalhes;
            openModal('modalDetalhesRetirada');
        }

        // ==================== EXPORTAÇÃO DE COLABORADORES ====================
        function exportarColaboradoresPDF() {
            try {
                const colaboradoresFiltrados = obterColaboradoresFiltrados();
                
                if (colaboradoresFiltrados.length === 0) {
                    showAlert('Não há colaboradores para exportar com os filtros atuais!', 'warning');
                    return;
                }

                if (typeof window.jspdf === 'undefined') {
                    showAlert('Biblioteca jsPDF não carregada. Aguarde alguns segundos e tente novamente.', 'error');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');
                
                doc.setFont("helvetica");
                
                // Título
                doc.setFontSize(20);
                doc.setTextColor(33, 150, 243);
                doc.text('RELATÓRIO DE COLABORADORES', 148, 20, { align: 'center' });
                
                // Filtros aplicados
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                let currentY = 30;
                
                const empresaFiltro = document.getElementById('filtroEmpresaColaboradores').value;
                const cidadeFiltro = document.getElementById('filtroCidadeColaboradores').value;
                const statusFiltro = document.getElementById('filtroStatusColaboradores').value;
                const buscaFiltro = document.getElementById('searchColaborador').value;
                
                doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, currentY);
                doc.text(`Total: ${colaboradoresFiltrados.length} colaboradores`, 20, currentY + 7);
                
                // Informações dos filtros
                let filtrosInfo = '';
                if (empresaFiltro !== 'todas') filtrosInfo += `Empresa: ${empresaFiltro} `;
                if (cidadeFiltro !== 'todas') filtrosInfo += `Cidade: ${cidadeFiltro} `;
                if (statusFiltro !== 'ativo') filtrosInfo += `Status: ${statusFiltro} `;
                if (buscaFiltro) filtrosInfo += `Busca: "${buscaFiltro}"`;
                
                if (filtrosInfo) {
                    doc.text(`Filtros: ${filtrosInfo}`, 20, currentY + 14);
                    currentY += 21;
                } else {
                    currentY += 14;
                }
                
                // Cabeçalho da tabela
                const headers = [['#', 'Nome', 'Empresa', 'Cidade', 'Departamento', 'Status', 'Dependentes', 'Data Cadastro']];
                
                // Dados da tabela
                const data = colaboradoresFiltrados.map((colab, index) => [
                    index + 1,
                    colab.nome,
                    colab.empresa || '',
                    colab.cidade || '',
                    colab.departamento || '',
                    colab.status === 'ativo' ? 'Ativo' : 'Inativo',
                    (colab.dependentes?.length || 0).toString(),
                    colab.createdAt ? new Date(colab.createdAt).toLocaleDateString('pt-BR') : 'N/A'
                ]);
                
                // Gerar tabela
                doc.autoTable({
                    startY: currentY,
                    head: headers,
                    body: data,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 102, 204] },
                    styles: { fontSize: 9 },
                    columnStyles: {
                        0: { cellWidth: 15 }, // #
                        1: { cellWidth: 60 }, // Nome
                        2: { cellWidth: 40 }, // Empresa
                        3: { cellWidth: 30 }, // Cidade
                        4: { cellWidth: 40 }, // Departamento
                        5: { cellWidth: 25 }, // Status
                        6: { cellWidth: 25 }, // Dependentes
                        7: { cellWidth: 30 }  // Data
                    }
                });
                
                // Rodapé
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(
                        `Página ${i} de ${totalPages} • Gerado por ${currentUser?.nome || 'Sistema'} • ${new Date().toLocaleString('pt-BR')}`,
                        148, 
                        doc.internal.pageSize.height - 10, 
                        { align: 'center' }
                    );
                }
                
                // Salvar PDF
                const nomeArquivo = `colaboradores_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(nomeArquivo);
                showAlert(`Relatório exportado com ${colaboradoresFiltrados.length} colaboradores!`, 'success');
                
            } catch (erro) {
                console.error("Erro ao exportar PDF de colaboradores:", erro);
                showAlert('Erro ao exportar PDF: ' + erro.message, 'error');
            }
        }

        async function exportarColaboradoresExcel() {
            try {
                const colaboradoresFiltrados = obterColaboradoresFiltrados();
                
                if (colaboradoresFiltrados.length === 0) {
                    showAlert('Não há colaboradores para exportar com os filtros atuais!', 'warning');
                    return;
                }

                if (typeof XLSX === 'undefined') {
                    showAlert('Biblioteca Excel não carregada. Aguarde alguns segundos e tente novamente.', 'error');
                    return;
                }
                
                // Obter informações dos filtros
                const empresaFiltro = document.getElementById('filtroEmpresaColaboradores').value;
                const cidadeFiltro = document.getElementById('filtroCidadeColaboradores').value;
                const statusFiltro = document.getElementById('filtroStatusColaboradores').value;
                const buscaFiltro = document.getElementById('searchColaborador').value;
                
                // Preparar dados
                const dados = colaboradoresFiltrados.map((colab, index) => {
                    const dependentes = colab.dependentes || [];
                    const dependentesStr = dependentes.map(d => `${d.nome} (${d.parentesco})`).join('; ');
                    
                    return {
                        '#': index + 1,
                        'Nome': colab.nome,
                        'Empresa': colab.empresa || '',
                        'Cidade': colab.cidade || '',
                        'Departamento': colab.departamento || '',
                        'Status': colab.status === 'ativo' ? 'Ativo' : 'Inativo',
                        'Total Dependentes': dependentes.length,
                        'Dependentes': dependentesStr,
                        'Data Cadastro': colab.createdAt ? new Date(colab.createdAt).toLocaleDateString('pt-BR') : '',
                        'Última Atualização': colab.updatedAt ? new Date(colab.updatedAt).toLocaleDateString('pt-BR') : '',
                        'Cadastrado Por': colab.createdBy || 'Sistema'
                    };
                });

                // Criar planilha
                const ws = XLSX.utils.json_to_sheet(dados);
                
                // Adicionar informações de filtro como metadados
                if (empresaFiltro !== 'todas' || cidadeFiltro !== 'todas' || statusFiltro !== 'ativo' || buscaFiltro) {
                    const infoFiltros = [];
                    if (empresaFiltro !== 'todas') infoFiltros.push(`Empresa: ${empresaFiltro}`);
                    if (cidadeFiltro !== 'todas') infoFiltros.push(`Cidade: ${cidadeFiltro}`);
                    if (statusFiltro !== 'ativo') infoFiltros.push(`Status: ${statusFiltro}`);
                    if (buscaFiltro) infoFiltros.push(`Busca: "${buscaFiltro}"`);
                    
                    const infoRow = [
                        { v: `Relatório de Colaboradores - Filtros: ${infoFiltros.join(', ')}`, t: 's' },
                        { v: `Total: ${colaboradoresFiltrados.length} colaboradores`, t: 's' },
                        { v: `Data: ${new Date().toLocaleDateString('pt-BR')}`, t: 's' },
                        { v: `Gerado por: ${currentUser?.nome || 'Sistema'}`, t: 's' }
                    ];
                    
                    // Adicionar linha de informações no topo
                    XLSX.utils.sheet_add_aoa(ws, [infoRow.map(cell => cell.v)], { origin: -1 });
                }
                
                // Ajustar largura das colunas
                const wscols = [
                    { wch: 5 },   // #
                    { wch: 30 },  // Nome
                    { wch: 20 },  // Empresa
                    { wch: 15 },  // Cidade
                    { wch: 20 },  // Departamento
                    { wch: 10 },  // Status
                    { wch: 15 },  // Total Dependentes
                    { wch: 40 },  // Dependentes
                    { wch: 15 },  // Data Cadastro
                    { wch: 15 },  // Última Atualização
                    { wch: 20 }   // Cadastrado Por
                ];
                ws['!cols'] = wscols;
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Colaboradores");

                XLSX.writeFile(wb, `colaboradores_${new Date().toISOString().split('T')[0]}.xlsx`);
                showAlert(`Relatório exportado com ${colaboradoresFiltrados.length} colaboradores!`, 'success');

            } catch (erro) {
                console.error("Erro ao exportar colaboradores:", erro);
                showAlert('Erro ao exportar colaboradores. Tente novamente.', 'error');
            }
        }

        // ==================== EXPORTAÇÃO DE RELATÓRIOS ====================
        async function exportarRelatorioPDF() {
            try {
                const mesSelecionado = document.getElementById('mesRelatorio').value;
                const anoSelecionado = document.getElementById('anoRelatorio').value;
                const empresaSelecionada = document.getElementById('empresaRelatorio').value;
                const cidadeSelecionada = document.getElementById('cidadeRelatorio').value;
                const tipoLista = document.getElementById('tipoListaRelatorio').value;
                
                if (!mesSelecionado || !anoSelecionado) {
                    showAlert('Selecione o mês e ano para exportar!', 'error');
                    return;
                }
                
                if (typeof window.jspdf === 'undefined') {
                    showAlert('Biblioteca jsPDF não carregada. Aguarde alguns segundos e tente novamente.', 'error');
                    return;
                }
                
                const mesReferencia = `${anoSelecionado}-${mesSelecionado}`;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFont("helvetica");
                
                // Configurações
                const marginLeft = 20;
                const marginTop = 20;
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                let currentY = marginTop;
                
                // Título
                doc.setFontSize(20);
                doc.setTextColor(33, 150, 243);
                doc.text('RELATÓRIO DE RETIRADA DE CESTAS', pageWidth / 2, currentY, { align: 'center' });
                currentY += 15;
                
                // Informações do relatório
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Período: ${mesSelecionado}/${anoSelecionado}`, marginLeft, currentY);
                currentY += 7;
                doc.text(`Empresa: ${empresaSelecionada === 'todas' ? 'Todas' : empresaSelecionada}`, marginLeft, currentY);
                currentY += 7;
                doc.text(`Cidade: ${cidadeSelecionada === 'todas' ? 'Todas' : cidadeSelecionada}`, marginLeft, currentY);
                currentY += 7;
                doc.text(`Filtro: ${getTipoListaDescricao(tipoLista)}`, marginLeft, currentY);
                currentY += 7;
                doc.text(`Data do Relatório: ${new Date().toLocaleDateString('pt-BR')}`, marginLeft, currentY);
                currentY += 15;
                
                // Estatísticas
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('ESTATÍSTICAS', marginLeft, currentY);
                currentY += 10;
                
                doc.setFontSize(12);
                const totalColaboradores = document.getElementById('relatorioTotalColaboradores').textContent;
                const totalRetiradas = document.getElementById('relatorioTotalRetiradas').textContent;
                const percentual = document.getElementById('relatorioPercentual').textContent;
                
                doc.text(`Total de Colaboradores: ${totalColaboradores}`, marginLeft, currentY);
                currentY += 7;
                doc.text(`Retiradas Realizadas: ${totalRetiradas}`, marginLeft, currentY);
                currentY += 7;
                doc.text(`Percentual Retirado: ${percentual}`, marginLeft, currentY);
                currentY += 15;
                
                // Carregar dados do relatório
                const retiradasMes = await carregarRetiradasPorMes(mesReferencia);
                
                // Filtrar colaboradores (apenas ativos para relatórios)
                let colaboradoresFiltrados = [...colaboradoresLista.filter(c => c.status !== 'inativo')];
                if (empresaSelecionada !== 'todas') {
                    colaboradoresFiltrados = colaboradoresFiltrados.filter(c => c.empresa === empresaSelecionada);
                }
                if (cidadeSelecionada !== 'todas') {
                    colaboradoresFiltrados = colaboradoresFiltrados.filter(c => c.cidade === cidadeSelecionada);
                }
                
                // Filtrar retiradas pelos mesmos filtros de empresa e cidade
                let retiradasFiltradas = retiradasMes.filter(r => {
                    const colaborador = colaboradoresLista.find(c => c.id === r.colaboradorTitularId);
                    if (!colaborador) return false;
                    
                    let empresaOk = empresaSelecionada === 'todas' || colaborador.empresa === empresaSelecionada;
                    let cidadeOk = cidadeSelecionada === 'todas' || colaborador.cidade === cidadeSelecionada;
                    
                    return empresaOk && cidadeOk;
                });
                
                const retiradosIds = [...new Set(retiradasFiltradas.map(r => r.colaboradorTitularId))];
                const jaRetiraram = colaboradoresFiltrados.filter(c => retiradosIds.includes(c.id));
                const naoRetiraram = colaboradoresFiltrados.filter(c => !retiradosIds.includes(c.id));
                
                // Verificar se precisa de nova página
                if (currentY > pageHeight - 50) {
                    doc.addPage();
                    currentY = marginTop;
                }
                
                // Seção 1: Colaboradores que Já Retiraram (se aplicável)
                if (tipoLista === 'ambas' || tipoLista === 'retirados') {
                    doc.setFontSize(14);
                    doc.text('COLABORADORES QUE JÁ RETIRARAM', marginLeft, currentY);
                    currentY += 10;
                    
                    if (jaRetiraram.length > 0) {
                        doc.setFontSize(10);
                        let count = 1;
                        
                        for (const colab of jaRetiraram) {
                            if (currentY > pageHeight - 20) {
                                doc.addPage();
                                currentY = marginTop;
                            }
                            
                            const retiradaDoColab = retiradasFiltradas.find(r => r.colaboradorTitularId === colab.id);
                            let linha = `${count}. ${colab.nome}`;
                            
                            // Adicionar informações extras se couber
                            if (retiradaDoColab && currentY < pageHeight - 30) {
                                linha += ` (Retirado por: ${retiradaDoColab.quemRetirouNome} - ${new Date(retiradaDoColab.dataRetirada).toLocaleDateString('pt-BR')})`;
                            }
                            
                            doc.text(linha, marginLeft, currentY);
                            currentY += 6;
                            count++;
                        }
                    } else {
                        doc.setFontSize(10);
                        doc.text('Nenhum colaborador retirou neste período.', marginLeft, currentY);
                        currentY += 10;
                    }
                    
                    currentY += 10;
                }
                
                // Verificar se precisa de nova página
                if (currentY > pageHeight - 50) {
                    doc.addPage();
                    currentY = marginTop;
                }
                
                // Seção 2: Colaboradores que Não Retiraram (se aplicável)
                if (tipoLista === 'ambas' || tipoLista === 'nao_retirados') {
                    doc.setFontSize(14);
                    doc.text('COLABORADORES QUE NÃO RETIRARAM', marginLeft, currentY);
                    currentY += 10;
                    
                    if (naoRetiraram.length > 0) {
                        doc.setFontSize(10);
                        let count = 1;
                        
                        for (const colab of naoRetiraram) {
                            if (currentY > pageHeight - 20) {
                                doc.addPage();
                                currentY = marginTop;
                            }
                            
                            doc.text(`${count}. ${colab.nome} - ${colab.empresa || ''} - ${colab.departamento || ''}`, marginLeft, currentY);
                            currentY += 6;
                            count++;
                        }
                    } else {
                        doc.setFontSize(10);
                        doc.text('Todos os colaboradores retiraram neste período.', marginLeft, currentY);
                        currentY += 10;
                    }
                    
                    currentY += 10;
                }
                
                // Rodapé
                const totalPaginas = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPaginas; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Página ${i} de ${totalPaginas} • Gerado por ${currentUser?.nome || 'Sistema'} em ${new Date().toLocaleString('pt-BR')}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }
                
                // Salvar o PDF
                const meses = [
                    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                const mesFormatado = meses[parseInt(mesSelecionado) - 1];
                const nomeArquivo = `relatorio_cestas_${mesFormatado}_${anoSelecionado}.pdf`;
                
                doc.save(nomeArquivo);
                showAlert('Relatório exportado em PDF com sucesso!', 'success');
                
            } catch (erro) {
                console.error("Erro ao exportar PDF:", erro);
                showAlert('Erro ao exportar PDF: ' + erro.message, 'error');
            }
        }

        function getTipoListaDescricao(tipoLista) {
            switch(tipoLista) {
                case 'ambas': return 'Ambas as listas';
                case 'retirados': return 'Apenas Retirados';
                case 'nao_retirados': return 'Apenas Não Retirados';
                default: return 'Ambas as listas';
            }
        }

        async function exportarRelatorioExcel() {
            try {
                const mesSelecionado = document.getElementById('mesRelatorio').value;
                const anoSelecionado = document.getElementById('anoRelatorio').value;
                const empresaSelecionada = document.getElementById('empresaRelatorio').value;
                const cidadeSelecionada = document.getElementById('cidadeRelatorio').value;
                const tipoLista = document.getElementById('tipoListaRelatorio').value;
                
                if (!mesSelecionado || !anoSelecionado) {
                    showAlert('Selecione o mês e ano para exportar!', 'error');
                    return;
                }

                if (typeof XLSX === 'undefined') {
                    showAlert('Biblioteca Excel não carregada. Aguarde alguns segundos e tente novamente.', 'error');
                    return;
                }

                // Carregar dados do relatório
                const mesReferencia = `${anoSelecionado}-${mesSelecionado}`;
                const retiradasMes = await carregarRetiradasPorMes(mesReferencia);
                
                // Filtrar colaboradores (apenas ativos para relatórios)
                let colaboradoresFiltrados = [...colaboradoresLista.filter(c => c.status !== 'inativo')];
                if (empresaSelecionada !== 'todas') {
                    colaboradoresFiltrados = colaboradoresFiltrados.filter(c => c.empresa === empresaSelecionada);
                }
                if (cidadeSelecionada !== 'todas') {
                    colaboradoresFiltrados = colaboradoresFiltrados.filter(c => c.cidade === cidadeSelecionada);
                }
                
                // Filtrar retiradas pelos mesmos filtros de empresa e cidade
                let retiradasFiltradas = retiradasMes.filter(r => {
                    const colaborador = colaboradoresLista.find(c => c.id === r.colaboradorTitularId);
                    if (!colaborador) return false;
                    
                    let empresaOk = empresaSelecionada === 'todas' || colaborador.empresa === empresaSelecionada;
                    let cidadeOk = cidadeSelecionada === 'todas' || colaborador.cidade === cidadeSelecionada;
                    
                    return empresaOk && cidadeOk;
                });
                
                const retiradosIds = [...new Set(retiradasFiltradas.map(r => r.colaboradorTitularId))];
                const jaRetiraram = colaboradoresFiltrados.filter(c => retiradosIds.includes(c.id));
                const naoRetiraram = colaboradoresFiltrados.filter(c => !retiradosIds.includes(c.id));
                
                // Ordenar
                jaRetiraram.sort((a, b) => a.nome.localeCompare(b.nome));
                naoRetiraram.sort((a, b) => a.nome.localeCompare(b.nome));
                
                // Criar workbook
                const wb = XLSX.utils.book_new();
                
                // Adicionar estatísticas como primeira planilha
                const estatisticasData = [
                    ['RELATÓRIO DE RETIRADA DE CESTAS'],
                    [''],
                    [`Período: ${mesSelecionado}/${anoSelecionado}`],
                    [`Empresa: ${empresaSelecionada === 'todas' ? 'Todas' : empresaSelecionada}`],
                    [`Cidade: ${cidadeSelecionada === 'todas' ? 'Todas' : cidadeSelecionada}`],
                    [`Filtro: ${getTipoListaDescricao(tipoLista)}`],
                    [`Data do Relatório: ${new Date().toLocaleDateString('pt-BR')}`],
                    [`Gerado por: ${currentUser?.nome || 'Sistema'}`],
                    [''],
                    ['ESTATÍSTICAS'],
                    [''],
                    ['Total de Colaboradores:', colaboradoresFiltrados.length],
                    ['Retiradas Realizadas:', retiradasFiltradas.length],
                    ['Percentual Retirado:', colaboradoresFiltrados.length > 0 ? 
                        ((retiradasFiltradas.length / colaboradoresFiltrados.length) * 100).toFixed(1) + '%' : '0%']
                ];
                
                const wsEstatisticas = XLSX.utils.aoa_to_sheet(estatisticasData);
                XLSX.utils.book_append_sheet(wb, wsEstatisticas, "Estatísticas");
                
                // Adicionar planilha de Colaboradores que Já Retiraram (se aplicável)
                if ((tipoLista === 'ambas' || tipoLista === 'retirados') && jaRetiraram.length > 0) {
                    const jaRetiraramData = jaRetiraram.map((colab, index) => {
                        const retiradaDoColab = retiradasFiltradas.find(r => r.colaboradorTitularId === colab.id);
                        return {
                            '#': index + 1,
                            'Nome': colab.nome,
                            'Empresa': colab.empresa || '',
                            'Cidade': colab.cidade || '',
                            'Departamento': colab.departamento || '',
                            'Quem Retirou': retiradaDoColab ? retiradaDoColab.quemRetirouNome : '',
                            'Tipo Retirante': retiradaDoColab ? retiradaDoColab.quemRetirouTipo : '',
                            'Data Retirada': retiradaDoColab ? new Date(retiradaDoColab.dataRetirada).toLocaleString('pt-BR') : '',
                            'Registrado por': retiradaDoColab ? retiradaDoColab.createdBy || '' : ''
                        };
                    });
                    
                    const wsJaRetiraram = XLSX.utils.json_to_sheet(jaRetiraramData);
                    XLSX.utils.book_append_sheet(wb, wsJaRetiraram, "Retirados");
                }
                
                // Adicionar planilha de Colaboradores que Não Retiraram (se aplicável)
                if ((tipoLista === 'ambas' || tipoLista === 'nao_retirados') && naoRetiraram.length > 0) {
                    const naoRetiraramData = naoRetiraram.map((colab, index) => ({
                        '#': index + 1,
                        'Nome': colab.nome,
                        'Empresa': colab.empresa || '',
                        'Cidade': colab.cidade || '',
                        'Departamento': colab.departamento || '',
                        'Status': 'Não Retirou'
                    }));
                    
                    const wsNaoRetiraram = XLSX.utils.json_to_sheet(naoRetiraramData);
                    XLSX.utils.book_append_sheet(wb, wsNaoRetiraram, "Não Retiraram");
                }
                
                // Salvar arquivo
                const meses = [
                    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                const mesFormatado = meses[parseInt(mesSelecionado) - 1];
                const nomeArquivo = `relatorio_cestas_${mesFormatado}_${anoSelecionado}.xlsx`;
                
                XLSX.writeFile(wb, nomeArquivo);
                showAlert('Relatório exportado em Excel com sucesso!', 'success');
                
            } catch (erro) {
                console.error("Erro ao exportar Excel:", erro);
                showAlert('Erro ao exportar Excel. Tente novamente.', 'error');
            }
        }

        // ==================== RECIBO ====================
        function gerarReciboHTML() {
            const db = new LocalDatabase();
            const config = db.getConfig();
            const empresaNome = config.empresaNome || 'WSNET TELECOM';
            
            const colaborador = colaboradoresLista.find(c => c.id === ultimaRetiradaRegistrada.colaboradorTitularId);
            
            return `
                <div class="recibo">
                    <div class="header">
                        <div class="title">${empresaNome}</div>
                        <div class="subtitle">Recibo de Retirada de Cesta</div>
                    </div>
                    
                    <div class="item">
                        <span class="label">Colaborador:</span>
                        <span>${ultimaRetiradaRegistrada.colaboradorTitularNome}</span>
                    </div>
                    
                    ${colaborador ? `
                        <div class="item">
                            <span class="label">Empresa:</span>
                            <span>${colaborador.empresa}</span>
                        </div>
                        <div class="item">
                            <span class="label">Cidade:</span>
                            <span>${colaborador.cidade}</span>
                        </div>
                        <div class="item">
                            <span class="label">Departamento:</span>
                            <span>${colaborador.departamento}</span>
                        </div>
                    ` : ''}
                    
                    <div class="item">
                        <span class="label">Retirado por:</span>
                        <span>${ultimaRetiradaRegistrada.quemRetirouNome} (${ultimaRetiradaRegistrada.quemRetirouTipo})</span>
                    </div>
                    
                    <div class="item">
                        <span class="label">Data:</span>
                        <span>${new Date(ultimaRetiradaRegistrada.dataRetirada).toLocaleDateString('pt-BR')}</span>
                    </div>
                    
                    <div class="item">
                        <span class="label">Hora:</span>
                        <span>${new Date(ultimaRetiradaRegistrada.dataRetirada).toLocaleTimeString('pt-BR')}</span>
                    </div>
                    
                    <div class="item">
                        <span class="label">Mês de Referência:</span>
                        <span>${ultimaRetiradaRegistrada.mesReferencia}</span>
                    </div>
                    
                    <div class="item">
                        <span class="label">Registrado por:</span>
                        <span>${ultimaRetiradaRegistrada.createdBy || 'Sistema'}</span>
                    </div>
                    
                    <div class="item">
                        <span class="label">Confirmado por:</span>
                        <span>${ultimaRetiradaRegistrada.confirmadoPor}</span>
                    </div>
                    
                    <div class="assinatura">
                        <div style="margin-top: 60px;">
                            _______________________________________
                        </div>
                        <div>Assinatura do Responsável</div>
                    </div>
                </div>
            `;
        }

        function imprimirRecibo() {
            const reciboHTML = gerarReciboHTML();
            const novaJanela = window.open();
            novaJanela.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Recibo de Retirada</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .recibo { border: 2px solid #000; padding: 20px; max-width: 600px; margin: 0 auto; }
                        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
                        .title { font-size: 24px; font-weight: bold; }
                        .subtitle { font-size: 18px; color: #666; }
                        .item { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #ddd; }
                        .label { font-weight: bold; }
                        .assinatura { margin-top: 50px; text-align: center; border-top: 1px solid #000; padding-top: 20px; }
                        .no-print { text-align: center; margin-top: 20px; }
                        @media print { body { margin: 0; } .recibo { border: none; } .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    ${reciboHTML}
                    <div class="no-print">
                        <button onclick="window.print()">Imprimir Recibo</button>
                        <button onclick="window.close()">Fechar</button>
                    </div>
                </body>
                </html>
            `);
        }

        // ==================== INICIALIZAÇÃO ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== SISTEMA INICIANDO ===');
            
            try {
                const db = new LocalDatabase();
                console.log('Banco de dados local inicializado com sucesso!');
                
                const usuarios = db.getUsuarios();
                console.log(`Total de usuários no sistema: ${usuarios.length}`);
                
                // Verificar se usuário já está logado
                checkLoggedInUser();
                
            } catch (error) {
                console.error('Erro ao inicializar banco de dados:', error);
                showLoginScreen();
            }
            
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    
                    console.log('Formulário de login submetido');
                    login(email, password);
                });
                console.log('Formulário de login configurado');
            } else {
                console.error('Formulário de login não encontrado!');
            }
            
            const loginPassword = document.getElementById('loginPassword');
            if (loginPassword) {
                loginPassword.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        loginForm.dispatchEvent(new Event('submit'));
                    }
                });
            }
            
            // Fechar modal ao clicar no overlay
            document.addEventListener('click', function(event) {
                const modals = ['modalColaborador', 'modalDepartamentos', 'modalEmpresas', 'modalNovoMes', 'modalRetirada', 'modalDetalhesRetirada', 'modalLimparRetiradas', 'confirmacaoRetirada', 'modalCancelarRetirada'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal && modal.style.display === 'block' && event.target === modal) {
                        closeModal(modalId);
                    }
                });
            });
            
            // Inicializar listas vazias
            colaboradoresLista = [];
            retiradasLista = [];
            empresasLista = [];
            
            console.log('=== SISTEMA PRONTO PARA USO ===');
        });
    </script>
</body>
</html>